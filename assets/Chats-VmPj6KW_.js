const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatPanel-CaE5gEbD.js","assets/index-Bb5NL_wz.js","assets/react-Dymf0t1b.js","assets/supabase-BesQZUkt.js","assets/index-DHhJzFMc.css","assets/useGroupPresence-tYl0lI6c.js","assets/ViewOtherProfileModal-D2rFZp_8.js","assets/user-plus-KDktbtf-.js","assets/map-pin-DUTuw-v1.js","assets/send-sLklyjtF.js"])))=>i.map(i=>d[i]);
import{c as z,j as e,s as m,U as H,M as q,_ as J}from"./index-Bb5NL_wz.js";import{i as B,u as K,c as n}from"./react-Dymf0t1b.js";import{V as W}from"./ViewOtherProfileModal-D2rFZp_8.js";import{S as Q}from"./search-COva-y9E.js";import{A as X}from"./arrow-left-Ch5JQfS3.js";import{S as Y}from"./send-sLklyjtF.js";import"./supabase-BesQZUkt.js";import"./user-plus-KDktbtf-.js";const Z=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],ee=z("funnel",Z);const te=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]],D=z("heart",te);function P({size:h=20,className:p=""}){return e.jsxs("svg",{className:`animate-spin ${p}`,width:h,height:h,viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]})}const se=n.lazy(()=>J(()=>import("./ChatPanel-CaE5gEbD.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])));function me(){const h=B(),p=K(),[u,O]=n.useState(null),[g,j]=n.useState([]),[_,R]=n.useState(!0),[s,f]=n.useState(null),[S,C]=n.useState(null),[y,F]=n.useState([]),[x,$]=n.useState(""),[k,I]=n.useState(!1),N=n.useRef(null),[v,T]=n.useState("all"),[L,U]=n.useState("");n.useEffect(()=>{async function t(){const{data:{user:r}}=await m.auth.getUser();if(!r)return;O(r.id);const a=new Set(JSON.parse(localStorage.getItem("chat_favorites")||"[]")),{data:l}=await m.from("group_members").select("group_id, groups(id, title, category)").eq("user_id",r.id).eq("status","active"),{data:i}=await m.from("friendships").select("user_id_a, user_id_b").or(`user_id_a.eq.${r.id},user_id_b.eq.${r.id}`).eq("status","accepted"),o=[];if(l&&l.forEach(d=>{d.groups&&o.push({type:"group",id:d.groups.id,name:d.groups.title,avatar_url:null,subtitle:d.groups.category||"Group",isFavorite:a.has(d.groups.id)})}),i){const d=i.map(c=>c.user_id_a===r.id?c.user_id_b:c.user_id_a);if(d.length>0){const{data:c}=await m.from("profiles").select("user_id, name, avatar_url").in("user_id",d);c?.forEach(w=>{o.push({type:"dm",id:w.user_id,name:w.name||"User",avatar_url:w.avatar_url,subtitle:"Direct Message",isFavorite:a.has(w.user_id)})})}}o.sort((d,c)=>d.isFavorite&&!c.isFavorite?-1:!d.isFavorite&&c.isFavorite?1:d.name.localeCompare(c.name)),j(o),R(!1)}t()},[]);const M=t=>{const r=new Set(JSON.parse(localStorage.getItem("chat_favorites")||"[]"));let a=!1;r.has(t)?(r.delete(t),a=!1):(r.add(t),a=!0),localStorage.setItem("chat_favorites",JSON.stringify(Array.from(r))),j(l=>l.map(i=>i.id===t?{...i,isFavorite:a}:i).sort((i,o)=>i.isFavorite&&!o.isFavorite?-1:!i.isFavorite&&o.isFavorite?1:i.name.localeCompare(o.name))),s&&s.id===t&&f(l=>l?{...l,isFavorite:a}:null)};n.useEffect(()=>{const t=p.state?.openDmId;if(t&&g.length>0&&!s){const r=g.find(a=>a.id===t&&a.type==="dm");r?f(r):(async()=>{const{data:a}=await m.from("profiles").select("name, avatar_url").eq("user_id",t).single();if(a){const l=new Set(JSON.parse(localStorage.getItem("chat_favorites")||"[]")),i={type:"dm",id:t,name:a.name||"User",avatar_url:a.avatar_url,subtitle:"Direct Message",isFavorite:l.has(t)};j(o=>[i,...o]),f(i)}})(),window.history.replaceState({},"")}},[p.state,g,s]),n.useEffect(()=>{if(!u||!s||s.type!=="dm")return;let t=null;async function r(){I(!0);const a=s.id,{data:l}=await m.from("direct_messages").select("*").or(`and(from_id.eq.${u},to_id.eq.${a}),and(from_id.eq.${a},to_id.eq.${u})`).order("created_at",{ascending:!0}).limit(100);F(l||[]),I(!1),setTimeout(()=>N.current?.scrollIntoView({behavior:"smooth"}),100),t=m.channel(`dm:${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"direct_messages"},i=>{const o=i.new;(o.from_id===u&&o.to_id===a||o.from_id===a&&o.to_id===u)&&(F(c=>[...c,o]),setTimeout(()=>N.current?.scrollIntoView({behavior:"smooth"}),100))}).subscribe()}return r(),()=>{t&&m.removeChannel(t)}},[s,u]);const E=async()=>{if(!x.trim()||!u||!s||s.type!=="dm")return;const t=x.trim();$(""),await m.from("direct_messages").insert({from_id:u,to_id:s.id,body:t})},A=g.filter(t=>!(v==="groups"&&t.type!=="group"||v==="private"&&t.type!=="dm"||v==="fav"&&!t.isFavorite||!t.name.toLowerCase().includes(L.toLowerCase()))),b=({id:t,label:r})=>e.jsx("button",{onClick:()=>T(t),className:`
        whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-semibold transition-all border
        ${v===t?"bg-neutral-900 text-white border-neutral-900 shadow-md transform scale-105":"bg-white text-neutral-600 border-neutral-200 hover:bg-neutral-50 hover:border-neutral-300"}
      `,children:r}),V=()=>e.jsxs("div",{className:`flex flex-col h-full bg-white border-r border-neutral-200 ${s?"hidden md:flex":"flex"} w-full md:w-80 lg:w-96`,children:[e.jsxs("div",{className:"p-5 border-b border-neutral-100 bg-white/80 backdrop-blur-md sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-neutral-900 tracking-tight",children:"Chats"}),_&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-neutral-900"})]}),e.jsxs("div",{className:"relative mb-4 group",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-neutral-400 group-focus-within:text-emerald-600 transition-colors",children:e.jsx(Q,{className:"h-4 w-4"})}),e.jsx("input",{value:L,onChange:t=>U(t.target.value),placeholder:"Search conversations...",className:"block w-full pl-10 pr-3 py-2.5 border border-neutral-200 rounded-xl leading-5 bg-neutral-50 placeholder-neutral-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm font-medium"})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1 scrollbar-hide",children:[e.jsx(b,{id:"all",label:"All"}),e.jsx(b,{id:"groups",label:"Groups"}),e.jsx(b,{id:"private",label:"Private"}),e.jsx(b,{id:"fav",label:"Favorites"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:_?e.jsx("div",{className:"p-8 flex justify-center",children:e.jsx(P,{})}):A.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-neutral-400 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-neutral-50 rounded-full flex items-center justify-center mb-4",children:e.jsx(ee,{className:"h-6 w-6 opacity-30"})}),e.jsx("p",{className:"text-sm font-medium",children:"No chats found."}),e.jsx("p",{className:"text-xs mt-1 opacity-70",children:"Try adjusting your filters or search."})]}):e.jsx("div",{className:"px-2 py-2 space-y-1",children:A.map(t=>e.jsxs("div",{className:"group relative",children:[e.jsxs("button",{onClick:()=>f(t),className:`
                    w-full flex items-center gap-3 p-3 rounded-xl text-left transition-all duration-200
                    ${s?.id===t.id?"bg-emerald-50 shadow-sm ring-1 ring-emerald-100":"hover:bg-neutral-50"}
                  `,children:[e.jsx("div",{className:`
                    h-12 w-12 rounded-full flex items-center justify-center text-lg font-bold shrink-0 shadow-sm
                    ${t.type==="group"?"bg-gradient-to-br from-indigo-100 to-indigo-200 text-indigo-700":"bg-gradient-to-br from-neutral-100 to-neutral-200 text-neutral-600"}
                  `,children:t.type==="dm"&&t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:"",className:"h-full w-full object-cover rounded-full"}):t.type==="group"?e.jsx(H,{className:"h-5 w-5"}):t.name.slice(0,1).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1 pr-8",children:[e.jsx("div",{className:`font-semibold truncate ${s?.id===t.id?"text-emerald-900":"text-neutral-900"}`,children:t.name}),e.jsx("div",{className:"text-xs text-neutral-500 truncate mt-0.5",children:t.subtitle})]})]}),e.jsx("button",{onClick:r=>{r.stopPropagation(),M(t.id)},className:`
                    absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full transition-all duration-200
                    hover:bg-white hover:shadow-sm
                    ${t.isFavorite?"opacity-100 text-rose-500":"opacity-0 group-hover:opacity-100 text-neutral-300 hover:text-rose-400"}
                  `,title:t.isFavorite?"Remove from Favorites":"Add to Favorites",children:e.jsx(D,{className:`h-4 w-4 ${t.isFavorite?"fill-current":""}`})})]},t.type+t.id))})})]}),G=()=>{if(!s)return e.jsxs("div",{className:"hidden md:flex flex-1 items-center justify-center bg-neutral-50/50 flex-col gap-6",children:[e.jsx("div",{className:"bg-white p-6 rounded-full shadow-sm ring-1 ring-black/5",children:e.jsx(q,{className:"h-12 w-12 text-emerald-500/50"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900",children:"Select a conversation"}),e.jsx("p",{className:"text-sm text-neutral-500 mt-1",children:"Choose a group or friend to start chatting"})]})]});const t=()=>{s.type==="group"?h(`/group/${s.id}`):s.type==="dm"&&C(s.id)};return e.jsxs("div",{className:"fixed inset-0 z-50 pb-20 md:pb-0 md:static md:inset-auto md:flex-1 bg-white flex flex-col h-full",children:[e.jsxs("div",{className:"h-[72px] border-b border-neutral-200 flex items-center px-4 gap-4 bg-white/95 backdrop-blur-sm shrink-0 shadow-sm z-20",children:[e.jsx("button",{onClick:()=>f(null),className:"md:hidden p-2 -ml-2 rounded-full hover:bg-neutral-100 transition-colors",children:e.jsx(X,{className:"h-5 w-5 text-neutral-600"})}),e.jsxs("div",{onClick:t,className:"flex items-center gap-4 flex-1 min-w-0 cursor-pointer hover:opacity-70 transition-opacity",title:`View ${s.type==="group"?"Group":"Profile"}`,children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center text-sm font-bold shadow-sm ${s.type==="group"?"bg-indigo-100 text-indigo-700":"bg-neutral-100 text-neutral-600"}`,children:s.type==="dm"&&s.avatar_url?e.jsx("img",{src:s.avatar_url,alt:"",className:"h-full w-full object-cover rounded-full"}):s.type==="group"?"#":s.name.slice(0,1)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-bold text-neutral-900 truncate text-base",children:s.name}),e.jsxs("div",{className:"text-xs text-neutral-500 flex items-center gap-1",children:[e.jsx("span",{className:`w-1.5 h-1.5 rounded-full ${s.type==="group"?"bg-indigo-500":"bg-emerald-500"}`}),s.type==="group"?"Group Chat":"Direct Message"]})]})]}),e.jsx("button",{onClick:()=>M(s.id),className:"p-2 rounded-full hover:bg-neutral-100 transition-colors focus:outline-none focus:ring-2 focus:ring-neutral-200",title:s.isFavorite?"Remove from Favorites":"Add to Favorites",children:e.jsx(D,{className:`h-5 w-5 transition-colors ${s.isFavorite?"fill-rose-500 text-rose-500":"text-neutral-400"}`})})]}),e.jsxs("div",{className:"flex-1 overflow-hidden relative bg-neutral-50",children:[e.jsx("div",{className:"absolute inset-0 opacity-[0.03] pointer-events-none",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='1'/%3E%3C/g%3E%3C/svg%3E")`}}),s.type==="group"?e.jsx(n.Suspense,{fallback:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx(P,{})}),children:e.jsx("div",{className:"h-full w-full relative z-10",children:e.jsx(se,{groupId:s.id,onClose:()=>f(null),full:!0,setFull:()=>{},user:{id:u}})})}):e.jsxs("div",{className:"flex flex-col h-full relative z-10",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[k&&e.jsx("div",{className:"flex justify-center py-4",children:e.jsx("div",{className:"bg-white/80 px-4 py-1.5 rounded-full text-xs font-medium text-neutral-500 shadow-sm border border-neutral-100",children:"Loading history..."})}),!k&&y.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-neutral-400 space-y-3",children:[e.jsx("div",{className:"w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center",children:e.jsx(q,{className:"h-8 w-8 text-neutral-200"})}),e.jsx("div",{className:"text-sm",children:"No messages yet. Say hi! ðŸ‘‹"})]}),y.map((r,a)=>{const l=r.from_id===u,i=!l&&(a===0||y[a-1].from_id!==r.from_id);return e.jsx("div",{className:`flex ${l?"justify-end":"justify-start"} group animate-in fade-in slide-in-from-bottom-2 duration-300`,children:e.jsxs("div",{className:`flex max-w-[80%] md:max-w-[70%] ${l?"flex-row-reverse":"flex-row"} items-end gap-2`,children:[!l&&e.jsx("div",{className:"w-6 h-6 shrink-0 mb-1",children:i&&(s.avatar_url?e.jsx("img",{src:s.avatar_url,className:"w-6 h-6 rounded-full object-cover shadow-sm"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 flex items-center justify-center text-[9px] font-bold text-neutral-500",children:s.name.slice(0,1)}))}),e.jsxs("div",{className:`
                          px-4 py-2.5 text-sm shadow-sm relative
                          ${l?"bg-gradient-to-br from-emerald-500 to-emerald-600 text-white rounded-2xl rounded-tr-sm":"bg-white text-neutral-800 border border-neutral-100 rounded-2xl rounded-tl-sm"}
                        `,children:[r.body,e.jsx("div",{className:`text-[9px] mt-1 text-right opacity-70 ${l?"text-emerald-100":"text-neutral-400"}`,children:new Date(r.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},r.id)}),e.jsx("div",{ref:N})]}),e.jsx("div",{className:"p-4 bg-white border-t border-neutral-200/80 backdrop-blur-md",children:e.jsxs("div",{className:"flex items-center gap-2 max-w-4xl mx-auto bg-neutral-50 border border-neutral-200 rounded-full px-2 py-2 focus-within:ring-2 focus-within:ring-emerald-500/20 focus-within:border-emerald-500 transition-all shadow-inner",children:[e.jsx("input",{value:x,onChange:r=>$(r.target.value),onKeyDown:r=>r.key==="Enter"&&E(),placeholder:"Type a message...",className:"flex-1 bg-transparent border-0 px-4 py-1 text-sm focus:ring-0 text-neutral-900 placeholder-neutral-400 outline-none"}),e.jsx("button",{onClick:E,disabled:!x.trim(),className:`
                      p-2.5 rounded-full transition-all duration-200 flex items-center justify-center shadow-sm
                      ${x.trim()?"bg-emerald-600 text-white hover:bg-emerald-700 hover:scale-105 active:scale-95":"bg-neutral-200 text-neutral-400 cursor-not-allowed"}
                    `,children:e.jsx(Y,{className:"h-4 w-4 ml-0.5"})})]})})]})]})]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex h-[calc(100vh-64px)] w-full overflow-hidden bg-white fixed top-0 left-0",children:[e.jsx(V,{}),e.jsx(G,{})]}),e.jsx(W,{isOpen:!!S,onClose:()=>C(null),viewUserId:S})]})}export{me as default};
