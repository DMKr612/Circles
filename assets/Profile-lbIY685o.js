import{u as Je,a as We,s as x,j as e}from"./index-D5DXlmNB.js";import{i as Ze,u as Ye,f as Ke,c as s,R as y,L as _e}from"./react-Dymf0t1b.js";import{V as Qe}from"./ViewOtherProfileModal-CdtUfFDC.js";import"./supabase-BesQZUkt.js";import"./user-plus-CHQJvumq.js";const Xe=u=>console.log("[ok]",u),et=u=>console.error("[err]",u);function tt(u){if(!u)return"—";const d=new Date(u);if(isNaN(d.getTime()))return"—";const i=Date.now(),n=Math.floor((i-d.getTime())/1e3);return n<5?"now":n<60?`${n}s`:n<3600?`${Math.floor(n/60)}m`:n<86400?`${Math.floor(n/3600)}h`:`${Math.floor(n/86400)}d`}function st(u,d){const i=(d??"").toString().trim();if(i)return i.toUpperCase();let n=2166136261;for(let o=0;o<u.length;o++)n^=u.charCodeAt(o),n+=(n<<1)+(n<<4)+(n<<7)+(n<<8)+(n<<24);return(n>>>0).toString(16).toUpperCase().padStart(8,"0").slice(-8)}const at=(()=>{const{State:u,City:d}=window.countryStateCity||{State:null,City:null};if(!u||!d)return[];try{const i=u.getStatesOfCountry("DE")||[],n=[];for(const r of i){const o=d.getCitiesOfState("DE",r.isoCode)||[];for(const h of o)h&&typeof h.name=="string"&&h.name.trim()&&n.push(h.name.trim())}return Array.from(new Set(n)).sort((r,o)=>r.localeCompare(o,"de"))}catch(i){return console.warn("Could not load cities list",i),[]}})();function Ce(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{return"UTC"}}function Qt(){const u=Ze(),d=Ye(),{userId:i}=Ke(),{user:n}=Je(),r=n?.id,{data:o,isLoading:h,error:R}=We(r??null);s.useEffect(()=>{o&&(ce(o.groups_created||0),de(o.groups_joined||0))},[o]),s.useEffect(()=>{r&&(async()=>{const{count:t,error:a}=await x.from("groups").select("id",{count:"exact",head:!0}).or(`creator_id.eq.${r},host_id.eq.${r}`);if(a){console.warn("Failed to load created groups count",a);return}ce(t??0)})()},[r]),s.useEffect(()=>{r&&(async()=>{const{count:t,error:a}=await x.from("group_members").select("group_id",{count:"exact",head:!0}).eq("user_id",r).eq("status","accepted");if(a){console.warn("Failed to load joined groups count",a);return}de(t??0)})()},[r]);const[G,T]=s.useState(!1),[V,Ee]=s.useState(!1),[I,_]=s.useState(!1),[nt,lt]=s.useState(!1),[B,z]=s.useState(!1),H=s.useRef(null),J=s.useRef(null),g=!!i&&i!==r,[W,Z]=s.useState(""),[Y,K]=s.useState(""),[C,M]=s.useState("UTC"),[Q,X]=s.useState(""),[$,ee]=s.useState("system"),[te,se]=s.useState(!1),[ae,re]=s.useState(!1),[k,ne]=s.useState(!0),[P,p]=s.useState(null),[U,E]=s.useState(!1),[Ae,le]=s.useState(!1),[D,Re]=s.useState([]),[it,Te]=s.useState(null),[ot,ie]=s.useState([]),[ct,oe]=s.useState(!1),[dt,Ie]=s.useState(null),[ut,mt]=s.useState(""),[ft,Me]=s.useState(!1),[O,ce]=s.useState(0),[F,de]=s.useState(0),[$e,xt]=s.useState(0),[ue,ht]=s.useState([]),[w,pt]=s.useState([]),[j,gt]=s.useState([]),[b,bt]=s.useState("created"),[A,Pe]=s.useState([]),[q,Ue]=s.useState(new Map),[me,vt]=s.useState([]),[fe,wt]=s.useState([]),[xe,jt]=s.useState([]),[he,De]=s.useState(null),[Oe,Nt]=s.useState(""),[Fe,St]=s.useState(null),[yt,_t]=s.useState(!0),[qe,Ct]=s.useState(0),[Le,kt]=s.useState(0),[Et,At]=s.useState(0),[Rt,Tt]=s.useState(!1),[It,Mt]=s.useState(null),[v,$t]=s.useState(null),[pe,Pt]=s.useState(!1),[Ut,Dt]=s.useState("none"),[Ot,Ft]=s.useState(0),[qt,Lt]=s.useState(0),[Gt,N]=s.useState(!1),[Vt,Bt]=s.useState(!1),[ge,be]=s.useState(null),[zt,Ht]=s.useState(null),ve=g?Oe||(i?i.slice(0,6):""):o?.name||n?.email||"",we=g?Fe:o?.avatar_url,je=g?qe:o?.rating_avg,Ne=g?Le:o?.rating_count,Se=(ve||"?").slice(0,2).toUpperCase()??"?";s.useMemo(()=>me.length+fe.length+xe.length,[me,fe,xe]),s.useMemo(()=>{const t=new Map;D.forEach(l=>t.set(l.other_id,l));const a=[...D];return A.map(l=>l.user_id_a===r?l.user_id_b:l.user_id_a).forEach(l=>{if(t.has(l)||!r)return;const m=q.get(l);a.push({other_id:l,name:m?.name&&m.name.trim()?m.name:l.slice(0,6),avatar_url:m?.avatar_url??null,last_body:"",last_at:new Date(0).toISOString(),last_from_me:!1,unread:!1})}),a.sort((l,m)=>m.last_at>l.last_at?1:m.last_at<l.last_at?-1:0),a},[D,A,q,r]),s.useMemo(()=>{if(b==="created")return w;if(b==="joined")return j;const t=new Map;for(const a of w)a?.id&&t.set(a.id,a);for(const a of j)a?.id&&!t.has(a.id)&&t.set(a.id,a);return Array.from(t.values())},[b,w,j]),s.useMemo(()=>{if(b==="created")return O;if(b==="joined")return F;const t=new Set;return w.forEach(a=>a?.id&&t.add(a.id)),j.forEach(a=>a?.id&&t.add(a.id)),t.size},[b,O,F,w,j]),s.useMemo(()=>{if(!v)return 0;const t=new Date(v).getTime();return Math.max(0,Math.floor((t-Date.now())/1e3))},[v]),s.useMemo(()=>v?new Date(v).getTime()>Date.now()&&!pe:!1,[v,pe]),s.useEffect(()=>{r&&(async()=>{const{data:t,error:a}=await x.from("friendships").select("id,user_id_a,user_id_b,status").or(`and(user_id_a.eq.${r},status.eq.accepted),and(user_id_b.eq.${r},status.eq.accepted)`);if(a&&console.error("Friend load error:",a),Pe(t||[]),t){const c=t.map(f=>f.user_id_a===r?f.user_id_b:f.user_id_a),{data:l}=await x.from("profiles").select("user_id,name,avatar_url").in("user_id",c),m=new Map;l?.forEach(f=>m.set(f.user_id,{name:f.name,avatar_url:f.avatar_url})),Ue(m)}})()},[r]),s.useLayoutEffect(()=>{d.hash==="#chat"&&T(!0)},[d.key,d.hash]),s.useEffect(()=>{const t=()=>T(!0);return window.addEventListener("open-chat",t),()=>window.removeEventListener("open-chat",t)},[]),s.useEffect(()=>{function t(a){const c=a.target;V&&J.current&&!J.current.contains(c)&&Ee(!1),G&&H.current&&!H.current.contains(c)&&T(!1)}return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[V,G]),s.useCallback(async t=>{Me(!1),Ie(null),oe(!0),ie([]),Te(t),Re(c=>c.map(l=>l.other_id===t?{...l,unread:!1,last_from_me:!0}:l));const{data:a}=await x.from("direct_messages").select("id,sender,receiver,content,created_at").or(`and(sender.eq.${r},receiver.eq.${t}),and(sender.eq.${t},receiver.eq.${r})`).order("created_at",{ascending:!0}).limit(200);ie(a??[]),oe(!1)},[r]);function ye(t){B&&he===t||(De(t),z(!0))}s.useEffect(()=>{if(!I||!r)return;const t=localStorage.getItem("theme");t&&ee(t);const a=localStorage.getItem("emailNotifs");a&&se(a==="1");const c=localStorage.getItem("pushNotifs");c&&re(c==="1"),(async()=>{const{data:l,error:m}=await x.from("profiles").select("name, city, timezone, interests, avatar_url, allow_ratings").eq("user_id",r).maybeSingle();if(m){p(m.message);return}const f=l?.name??"";Z(f),K(l?.city??""),M(l?.timezone??Ce());const S=Array.isArray(l?.interests)?l.interests:[];X(S.join(", ")),be(l?.avatar_url??null),ne(l?.allow_ratings??!0)})()},[I,r]);async function Ge(){if(r){p(null),E(!0);try{const t=W.trim();if(!t){p("Name cannot be empty."),E(!1);return}const a=Y.trim();if(!a){p("Please choose a city."),E(!1);return}const c=C.trim()||"UTC",l=Q.split(",").map(f=>f.trim()).filter(Boolean),{error:m}=await x.from("profiles").update({name:t,city:a,timezone:c,interests:l,allow_ratings:k,onboarded:!0}).eq("user_id",r);if(m)throw m;localStorage.setItem("theme",$),localStorage.setItem("emailNotifs",te?"1":"0"),localStorage.setItem("pushNotifs",ae?"1":"0"),ze($),p("Saved."),Xe("Profile saved"),N(!1),setTimeout(()=>{_(!1),p(null)},1e3)}catch(t){const a=t?.message||"Failed to save";p(a),et(a)}finally{E(!1)}}}async function Ve(t){if(ne(t),!!r)try{await x.from("profiles").update({allow_ratings:t}).eq("user_id",r)}catch{}}async function Be(t){const a=t.target.files?.[0];if(!(!r||!a))try{le(!0);const c=a.name.split(".").pop()||"jpg",l=`${r}/${Date.now()}.${c}`,{error:m}=await x.storage.from("avatars").upload(l,a,{upsert:!0});if(m)throw m;const{data:f}=x.storage.from("avatars").getPublicUrl(l),S=f?.publicUrl||null;S&&(await x.from("profiles").update({avatar_url:S}).eq("user_id",r),be(S))}catch(c){console.error(c),p("Avatar upload failed")}finally{le(!1)}}function ze(t){const a=document.documentElement;a.classList.remove("light","dark"),t==="light"?a.classList.add("light"):t==="dark"&&a.classList.add("dark")}async function He(){try{await x.auth.signOut()}catch{}try{localStorage.removeItem("onboardingSeen"),sessionStorage.clear()}catch{}const t=`${window.location.origin}/circles/`;try{if("serviceWorker"in navigator){const a=await navigator.serviceWorker.getRegistrations();await Promise.all(a.map(c=>c.unregister()))}}catch{}window.location.replace(t)}return h?e.jsx("div",{className:"flex h-screen items-center justify-center text-neutral-500",children:"Loading..."}):R||!o?e.jsx("div",{className:"p-4 text-red-500",children:"Failed to load profile."}):e.jsxs("div",{className:"mx-auto max-w-6xl px-4 pt-16 md:pt-20 pb-0",children:[e.jsx("div",{className:"grid gap-6 lg:grid-cols-[1fr_360px]",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6 flex items-center gap-4",children:[e.jsx("div",{className:"grid h-16 w-16 place-content-center rounded-full bg-emerald-100 text-emerald-800 ring-1 ring-emerald-300/60 overflow-hidden",children:we?e.jsx("img",{src:we,alt:"",className:"h-16 w-16 object-cover"}):e.jsx("span",{className:"text-2xl font-semibold tracking-wide",children:Se})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-lg font-semibold text-neutral-900",children:ve}),e.jsxs("div",{className:"mt-1 flex items-center gap-3 text-sm text-neutral-700",title:`${(je??0).toFixed(1)} / 6 from ${Ne??0} ratings`,children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[Array.from({length:6}).map((t,a)=>e.jsx("span",{children:a<Math.round(je||0)?"★":"☆"},a)),e.jsxs("span",{className:"ml-1 text-xs text-neutral-500",children:["(",Ne||0,")"]})]}),g&&e.jsx("button",{onClick:()=>ye(i),className:"text-xs text-emerald-700 hover:underline",children:"Rate"})]}),!g&&e.jsx("div",{className:"text-sm text-neutral-600",children:n?.email}),!g&&e.jsx("div",{className:"mt-2 flex items-center gap-2",children:e.jsx("button",{onClick:()=>_(!0),className:"ml-2 rounded-md border border-black/10 bg-white px-3 py-1.5 text-sm hover:bg-black/[0.04]",children:"Settings"})})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(L,{label:"Groups Created",value:O,onClick:()=>u("/groups?filter=created")}),e.jsx(L,{label:"Groups Joined",value:F,onClick:()=>u("/groups?filter=joined")}),e.jsx(L,{label:"Games Played",value:$e})]}),e.jsx(ke,{title:"Game Activity",count:ue.length,empty:"No game history yet.",children:ue.map(t=>e.jsxs("li",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"font-medium text-neutral-900",children:t.game}),e.jsx("span",{className:"text-neutral-600 text-sm",children:t.count})]},t.game))}),e.jsx(ke,{title:"Friends",count:A.length,empty:"No friends yet.",children:A.map(t=>{const a=t.user_id_a===r?t.user_id_b:t.user_id_a,c=q.get(a);return e.jsx(rt,{_otherId:a,name:c?.name||a.slice(0,6),avatarUrl:c?.avatar_url??null,lastBody:"",lastAt:new Date().toISOString(),unread:!1,onView:()=>ye(a)},a)})})]})}),I&&e.jsx("div",{className:"fixed inset-0 z-50 grid place-items-center bg-black/40",children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),Ge()},className:"w-[560px] max-w-[92vw] rounded-2xl border border-black/10 bg-white shadow-xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto px-5 py-4 space-y-4",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx("div",{className:"text-base font-semibold text-neutral-900",children:"Edit Profile"}),e.jsx("button",{type:"button",onClick:()=>_(!1),className:"absolute top-3 right-3 text-neutral-500 hover:text-neutral-800 text-xl leading-none",children:"×"})]}),e.jsxs("div",{className:"rounded-xl border border-black/5 bg-neutral-50/80 p-4 shadow-inner space-y-4",children:[e.jsx("div",{className:"text-sm font-semibold text-neutral-700",children:"Profile"}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-neutral-800",children:"Name"}),e.jsx("input",{value:W,onChange:t=>{Z(t.target.value),N(!0)},className:"w-full rounded-lg border border-black/10 bg-white px-3 py-2 text-sm focus:border-emerald-600",placeholder:"Your name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-neutral-800",children:"Avatar"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-neutral-200 grid place-items-center overflow-hidden",children:ge?e.jsx("img",{src:ge,alt:"",className:"h-10 w-10 object-cover"}):e.jsx("span",{className:"text-xs",children:Se})}),e.jsx("input",{type:"file",accept:"image/*",onChange:Be,className:"text-sm"}),Ae&&e.jsx("span",{className:"text-xs text-neutral-600",children:"Uploading…"})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-neutral-800",children:"City"}),e.jsx("input",{value:Y,onChange:t=>{K(t.target.value),N(!0)},onBlur:()=>{(!C||C==="UTC")&&M(Ce())},className:"w-full rounded-lg border border-black/10 bg-white px-3 py-2 text-sm focus:border-emerald-600",placeholder:"Start typing… e.g., Berlin",list:"cities-de",required:!0}),e.jsx("datalist",{id:"cities-de",children:at.map(t=>e.jsx("option",{value:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-neutral-800",children:"Timezone"}),e.jsx("input",{value:C,onChange:t=>{M(t.target.value),N(!0)},className:"w-full rounded-lg border border-black/10 bg-white px-3 py-2 text-sm focus:border-emerald-600",placeholder:"e.g., Europe/Berlin"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-neutral-800",children:"Interests"}),e.jsx("input",{value:Q,onChange:t=>{X(t.target.value),N(!0)},className:"w-full rounded-lg border border-black/10 bg-white px-3 py-2 text-sm focus:border-emerald-600",placeholder:"comma, separated, tags"})]})]}),e.jsxs("div",{className:"rounded-xl border border-black/5 bg-neutral-50/80 p-4 shadow-inner space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-neutral-700",children:"Appearance & Privacy"}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-neutral-800",children:"Theme"}),e.jsxs("select",{value:$,onChange:t=>ee(t.target.value),className:"w-full rounded-lg border border-black/10 bg-white px-3 py-2 text-sm focus:border-emerald-600",children:[e.jsx("option",{value:"system",children:"System"}),e.jsx("option",{value:"light",children:"Light"}),e.jsx("option",{value:"dark",children:"Dark"})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-lg border border-black/5 bg-white px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-neutral-800",children:"Allow profile ratings"}),e.jsx("div",{className:"text-[11px] text-neutral-500",children:"Others can rate you when enabled."})]}),e.jsx("button",{type:"button",onClick:()=>Ve(!k),className:`h-7 w-12 rounded-full ${k?"bg-emerald-600":"bg-neutral-300"} relative`,children:e.jsx("span",{className:`absolute top-0.5 h-6 w-6 rounded-full bg-white transition ${k?"right-0.5":"left-0.5"}`})})]})]}),e.jsxs("div",{className:"rounded-xl border border-black/5 bg-neutral-50/80 p-4 shadow-inner space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-neutral-700",children:"Notifications"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"emailNotifs",type:"checkbox",checked:te,onChange:t=>se(t.target.checked),className:"h-4 w-4 rounded border-black/20"}),e.jsx("label",{htmlFor:"emailNotifs",className:"text-sm text-neutral-800",children:"Email notifications"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pushNotifs",type:"checkbox",checked:ae,onChange:t=>re(t.target.checked),className:"h-4 w-4 rounded border-black/20"}),e.jsx("label",{htmlFor:"pushNotifs",className:"text-sm text-neutral-800",children:"Push notifications"})]})]}),P&&e.jsx("div",{className:`rounded-md border px-3 py-2 text-sm ${P==="Saved."?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-red-200 bg-red-50 text-red-700"}`,children:P})]}),e.jsxs("div",{className:"shrink-0 px-5 py-3 border-t border-black/10 space-y-3",children:[e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>_(!1),className:"rounded-md border border-black/10 bg-white px-3 py-1.5 text-sm",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:U,className:`rounded-md px-3 py-1.5 text-sm text-white ${U?"bg-neutral-400":"bg-emerald-600 hover:bg-emerald-700"}`,children:U?"Saving…":"Save"})]}),e.jsx("button",{type:"button",onClick:He,className:"w-full rounded-md border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-700 hover:bg-red-100",children:"Sign Out"})]})]})}),e.jsx(Qe,{isOpen:B,onClose:()=>z(!1),viewUserId:he})]})}const L=y.memo(function({label:d,value:i,onClick:n}){const r=e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-neutral-600",children:d}),e.jsx("div",{className:"mt-1 text-2xl font-semibold text-neutral-900",children:i})]});return n?e.jsx("button",{onClick:n,className:"w-full rounded-xl border border-black/10 bg-white p-4 text-left shadow-sm hover:shadow disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-sm",disabled:!n,children:r}):e.jsx("div",{className:"rounded-xl border border-black/10 bg-white p-4 shadow-sm",children:r})}),ke=y.memo(function({title:d,count:i,empty:n,children:r}){return e.jsxs("div",{className:"rounded-xl border border-black/10 bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("h3",{className:"text-base font-medium text-neutral-900",children:d}),e.jsx("span",{className:"text-xs text-neutral-600",children:i})]}),y.Children.count(r)===0?e.jsx("p",{className:"text-sm text-neutral-600",children:n}):e.jsx("ul",{className:"divide-y",children:r})]})});y.memo(function({id:d,title:i,meta:n,code:r}){const o=st(String(d),r);return e.jsxs("li",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{children:[e.jsx(_e,{to:`/group/${d}`,className:"font-medium text-neutral-900 hover:underline",children:i}),e.jsx("div",{className:"text-xs text-neutral-600",children:n}),e.jsxs("div",{className:"text-[11px] text-neutral-500 tracking-wider",children:["Code: ",o]})]}),e.jsx(_e,{to:`/group/${d}`,className:"text-sm text-emerald-700 hover:underline",children:"Open"})]})});const rt=y.memo(function({_otherId:d,name:i,avatarUrl:n,lastBody:r,lastAt:o,unread:h,onView:R}){return e.jsxs("li",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-9 w-9 rounded-full bg-neutral-200 grid place-items-center text-xs font-medium overflow-hidden",children:n?e.jsx("img",{src:n,alt:"",className:"h-9 w-9 rounded-full object-cover"}):i.slice(0,2).toUpperCase()}),e.jsxs("div",{children:[e.jsx("button",{onClick:R,className:"font-medium text-neutral-900 hover:underline text-left",children:i}),e.jsx("div",{className:"text-xs text-neutral-600 truncate max-w-[220px]",children:r})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-[10px] text-neutral-500",children:tt(o)}),h&&e.jsx("span",{className:"h-2 w-2 rounded-full bg-emerald-600"})]})]})});export{Qt as default};
