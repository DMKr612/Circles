import{c as h,s as n,j as e,M as se,U as re}from"./index-Bb5NL_wz.js";import{i as ne,c as s}from"./react-Dymf0t1b.js";import{U as le}from"./user-plus-KDktbtf-.js";const oe=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],ie=h("calendar",oe);const ce=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],D=h("triangle-alert",ce);const de=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],P=h("user-check",de);const ue=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],xe=h("x",ue),z=u=>alert(u);function be({isOpen:u,onClose:m,viewUserId:t}){const H=ne(),[i,L]=s.useState(null),[k,J]=s.useState(""),[S,X]=s.useState(null),[q,Y]=s.useState(!0),[me,R]=s.useState(0),[pe,M]=s.useState(0),[K,Q]=s.useState(0),[g,W]=s.useState(0),[G,A]=s.useState([]),[C,$]=s.useState([]),[E,b]=s.useState(0),[V,y]=s.useState(!1),[Z,j]=s.useState(null),[d,x]=s.useState("none"),[F,B]=s.useState(null),[T,N]=s.useState(!1);s.useEffect(()=>{(async()=>{const{data:a}=await n.auth.getUser();L(a.user?.id||null)})()},[]),s.useEffect(()=>{if(!u||!t||!i)return;B(null),y(!1),j(null),N(!1);async function a(){const{data:r}=await n.from("profiles").select("name,avatar_url,allow_ratings,rating_avg,rating_count").eq("user_id",t).maybeSingle();J(r?.name??"User"),X(r?.avatar_url??null),Y(!!(r?.allow_ratings??!0)),R(Number(r?.rating_avg??0)),M(Number(r?.rating_count??0));const{data:l}=await n.from("rating_pairs").select("stars").eq("rater_id",i).eq("ratee_id",t).maybeSingle();b(Number(l?.stars??0));const{data:o}=await n.from("friendships").select("status,requested_by").or(`and(user_id_a.eq.${i},user_id_b.eq.${t}),and(user_id_a.eq.${t},user_id_b.eq.${i})`).maybeSingle();let p="none";o&&(o.status==="accepted"?p="accepted":o.status==="blocked"?p="blocked":o.status==="pending"&&(p=o.requested_by===i?"pending_out":"pending_in")),x(p);const{data:ee}=await n.from("group_members").select("group_id").eq("user_id",t).eq("status","active"),f=(ee||[]).map(c=>c.group_id);if(Q(f.length),f.length>0){const{data:c}=await n.from("groups").select("title").in("id",f).limit(12);$((c||[]).map(v=>v.title))}else $([]);const{data:te}=await n.from("group_members").select("group_id").eq("user_id",i).eq("status","active"),ae=new Set((te||[]).map(c=>c.group_id)),w=f.filter(c=>ae.has(c));if(W(w.length),w.length>0){const{data:c}=await n.from("groups").select("title").in("id",w).limit(3);A((c||[]).map(v=>v.title))}else A([])}a()},[u,t,i]);async function _(a){if(t)try{a==="add"?(await n.rpc("request_friend",{target_id:t}),x("pending_out")):a==="accept"?(await n.rpc("accept_friend",{from_id:t}),x("accepted")):(await n.rpc("remove_friend",{other_id:t}),x("none"))}catch{}}async function O(){if(!(!i||!t)&&window.confirm("Are you sure you want to report and block this user? They will not be able to contact you.")){N(!0);try{const{error:a}=await n.from("reports").insert({reporter_id:i,reported_id:t,reason:"User Reported via Profile"});if(a)throw a;const{error:r}=await n.rpc("block_user",{target_id:t});if(r)throw r;z("User reported and blocked."),x("blocked"),m()}catch{z("Failed to report user.")}finally{N(!1)}}}async function U(a){if(!i||!t||V||!q)return;y(!0);const r=E;b(a);try{const{error:l}=await n.rpc("submit_rating",{p_ratee:t,p_stars:a});if(l)throw l;const{data:o}=await n.from("profiles").select("rating_avg,rating_count").eq("user_id",t).single();o&&(R(o.rating_avg),M(o.rating_count))}catch{b(r),B("Failed to rate.")}finally{y(!1)}}function I(){t&&(m(),H("/chats",{state:{openDmId:t}}))}return u?e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:m}),e.jsxs("div",{className:"relative w-full max-w-sm bg-white rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]",children:[e.jsx("button",{onClick:m,className:"absolute top-4 right-4 p-2 rounded-full bg-white text-neutral-500",children:e.jsx(xe,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex flex-col items-center mb-6",children:[e.jsx("div",{className:"h-24 w-24 rounded-full bg-neutral-200 overflow-hidden shadow-sm",children:S?e.jsx("img",{src:S,alt:"Avatar",className:"h-full w-full object-cover"}):e.jsx("div",{className:"h-full w-full flex items-center justify-center text-3xl font-bold text-neutral-500",children:k.slice(0,1).toUpperCase()})}),e.jsx("h2",{className:"text-xl font-bold mt-3",children:k})]}),e.jsxs("div",{className:"flex gap-3 mb-6",children:[e.jsxs("button",{onClick:I,className:"flex-1 py-2 rounded-xl bg-indigo-600 text-white text-sm font-bold flex items-center justify-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"})," Message"]}),d==="none"&&e.jsxs("button",{onClick:()=>_("add"),className:"flex-1 py-2 rounded-xl bg-black text-white text-sm font-bold flex items-center justify-center gap-2",children:[e.jsx(le,{className:"h-4 w-4"})," Add"]}),d==="pending_in"&&e.jsxs("button",{onClick:()=>_("accept"),className:"flex-1 py-2 rounded-xl bg-emerald-600 text-white text-sm font-bold flex items-center justify-center gap-2",children:[e.jsx(P,{className:"h-4 w-4"})," Accept"]}),d==="accepted"&&e.jsxs("button",{onClick:()=>_("remove"),className:"flex-1 py-2 rounded-xl bg-neutral-200 text-neutral-600 text-sm font-bold flex items-center justify-center gap-2",children:[e.jsx(P,{className:"h-4 w-4"})," Friends"]}),d==="blocked"&&e.jsxs("button",{disabled:!0,className:"flex-1 py-2 rounded-xl bg-red-600 text-white text-sm font-bold flex items-center justify-center gap-2 cursor-not-allowed",children:[e.jsx(D,{className:"h-4 w-4"})," Blocked"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-6",children:[e.jsxs("div",{className:"p-3 rounded-xl bg-neutral-50 text-center",children:[e.jsx("div",{className:"text-xl font-bold",children:K}),e.jsxs("div",{className:"text-[10px] uppercase font-bold text-neutral-500 mt-1 flex items-center justify-center gap-1",children:[e.jsx(ie,{className:"h-3 w-3"})," Groups Joined"]})]}),e.jsxs("div",{className:"p-3 rounded-xl bg-blue-50 text-center",children:[e.jsx("div",{className:"text-xl font-bold text-blue-600",children:g}),e.jsxs("div",{className:"text-[10px] uppercase font-bold text-blue-400 mt-1 flex items-center justify-center gap-1",children:[e.jsx(re,{className:"h-3 w-3"})," Mutual Groups"]})]})]}),e.jsxs("div",{className:"mb-6 bg-neutral-50 rounded-xl p-3 border border-neutral-100",children:[e.jsx("div",{className:"text-[10px] font-bold text-neutral-400 uppercase mb-2",children:"Groups they joined:"}),C.length===0?e.jsx("div",{className:"text-xs text-neutral-400",children:"No groups found."}):e.jsx("div",{className:"flex flex-wrap gap-1.5",children:C.map((a,r)=>e.jsx("span",{className:"px-2 py-0.5 bg-white border border-neutral-200 rounded-md text-xs font-medium text-neutral-700",children:a},r))})]}),G.length>0&&e.jsxs("div",{className:"mb-6 bg-neutral-50 rounded-xl p-3 border border-neutral-100",children:[e.jsx("div",{className:"text-[10px] font-bold text-neutral-400 uppercase mb-2",children:"You are both in:"}),e.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[G.map((a,r)=>e.jsx("span",{className:"px-2 py-0.5 bg-white border border-neutral-200 rounded-md text-xs font-medium text-neutral-700",children:a},r)),g>3&&e.jsxs("span",{className:"px-2 py-0.5 text-xs text-neutral-400",children:["+",g-3," more"]})]})]}),q&&d!=="blocked"&&e.jsxs("div",{className:"pt-3 border-t border-neutral-100",children:[e.jsx("div",{className:"text-center text-xs font-medium text-neutral-400 mb-2",children:"Rate this player"}),e.jsx("div",{className:"flex justify-center gap-1",children:Array.from({length:6}).map((a,r)=>{const l=r+1,o=(Z??E)>=l;return e.jsx("button",{disabled:V,onMouseEnter:()=>j(l),onMouseLeave:()=>j(null),onClick:()=>U(l),className:`text-2xl transition-transform hover:scale-110 ${o?"text-amber-400":"text-neutral-200"}`,"aria-label":`Rate ${l} star${l>1?"s":""}`,children:"â˜…"},l)})}),F&&e.jsx("div",{className:"text-center text-[10px] text-red-500 mt-1",children:F})]}),d!=="blocked"&&e.jsx("div",{className:"mt-6 flex justify-center",children:e.jsxs("button",{onClick:O,disabled:T,className:"flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-xl text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(D,{className:"h-4 w-4"}),T?"Reporting...":"Report & Block User"]})})]})]}):null}export{ie as C,be as V,xe as X};
