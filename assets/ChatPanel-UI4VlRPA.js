import{u as pe,s as m,j as t}from"./index-CckTKZT9.js";import{c as d}from"./react-Dymf0t1b.js";import"./supabase-BesQZUkt.js";const te=o=>{const x=Math.floor((Date.now()-new Date(o).getTime())/1e3);if(x<5)return"just now";if(x<60)return`${x}s`;const N=Math.floor(x/60);if(N<60)return`${N}m`;const v=Math.floor(N/60);if(v<24)return`${v}h`;const T=Math.floor(v/24);return T===1?"1d":`${T}d`},se=()=>{const o=typeof globalThis<"u"&&globalThis.crypto?globalThis.crypto:null;return o&&typeof o.randomUUID=="function"?o.randomUUID():Math.random().toString(36).slice(2)},xe=o=>`${se()}_${o.name}`;function je({groupId:o,pageSize:x=30,user:N,onClose:v,full:T,setFull:ge}){const[$,be]=d.useState(null),[g,j]=d.useState(new Map),[p,y]=d.useState([]),[F,U]=d.useState(new Map),[re,V]=d.useState(new Map),[q,H]=d.useState(""),[k,P]=d.useState(null),[b,M]=d.useState([]),[A,O]=d.useState(!1),[K,W]=d.useState(!1),[z,B]=d.useState(!0),[G,Y]=d.useState(!0),[J,ne]=d.useState(0),[Q,ae]=d.useState(null),[X,_]=d.useState(null),[S,ie]=d.useState([]),[le,oe]=d.useState(!1),L=d.useRef(null),w=d.useRef(null),Z=d.useMemo(()=>p.length?p[0].created_at:null,[p]),{user:I}=pe(),f=I?.id||null,C=I?.email||null;d.useEffect(()=>{let e=!1;async function r(n){const a=n.filter(c=>!g.has(c));if(!a.length)return;const{data:l}=await m.from("profiles").select("user_id,id,name,avatar_url").in("user_id",a);l&&j(c=>{const u=new Map(c);for(const h of l)u.set(h.user_id,h);return u})}async function s(n){if(!n.length)return;const{data:a}=await m.from("group_message_reactions").select("message_id,user_id,emoji").in("message_id",n);if(!a)return;const l=new Map;for(const c of a){const u=l.get(c.message_id)??{},h=u[c.emoji]??[];h.includes(c.user_id)||h.push(c.user_id),u[c.emoji]=h,l.set(c.message_id,u)}U(l)}async function i(n){if(!n.length)return;const{data:a}=await m.from("group_message_reads").select("message_id,user_id,read_at").in("message_id",n);if(!a)return;const l=new Map;for(const c of a){const u=l.get(c.message_id)??[];u.includes(c.user_id)||u.push(c.user_id),l.set(c.message_id,u)}V(l)}return(async()=>{B(!0);const{data:n,error:a}=await m.from("group_messages").select("id,group_id,user_id:author_id,content,created_at,parent_id,attachments").eq("group_id",o).order("created_at",{ascending:!1}).limit(x);if(e)return;if(a){console.error(a),B(!1);return}const l=(n??[]).reverse();y(l),Y((n??[]).length===x),B(!1),setTimeout(()=>w.current?.scrollIntoView({behavior:"smooth",block:"end"}),0);const c=Array.from(new Set(l.map(u=>u.user_id)));await r(c),await s(l.map(u=>u.id)),await i(l.map(u=>u.id))})(),()=>{e=!0}},[o,x]),d.useEffect(()=>{let e=!1;const r=async()=>{const{data:i,error:n}=await m.from("group_members").select("user_id, profiles(name,avatar_url)").eq("group_id",o);if(n){console.warn("[members] load error",n);return}if(e)return;const a=(i||[]).map(l=>({user_id:l.user_id,name:l.profiles?.name??null,avatar_url:l.profiles?.avatar_url??null}));ie(a),j(l=>{const c=new Map(l);for(const u of a)c.set(u.user_id,{user_id:u.user_id,name:u.name,avatar_url:u.avatar_url});return c})};r();const s=m.channel(`gm:${o}:members`).on("postgres_changes",{event:"*",schema:"public",table:"group_members",filter:`group_id=eq.${o}`},()=>{r()}).subscribe();return()=>{e=!1,m.removeChannel(s)}},[o]),d.useEffect(()=>{w.current?.scrollIntoView({behavior:"smooth",block:"end"})},[p.length]),d.useEffect(()=>{const e=m.channel(`gm:${o}`);return e.on("postgres_changes",{event:"INSERT",schema:"public",table:"group_messages"},async r=>{const s=r.new;if(s.group_id!==o)return;const i={id:s.id,group_id:s.group_id,user_id:s.user_id??s.author_id,content:s.content,created_at:s.created_at,parent_id:s.parent_id??null,attachments:s.attachments??[]};if(y(a=>{const l=Date.now()-3e4,c=a.filter(h=>!h.id.startsWith("phantom-")||h.user_id!==i.user_id||h.content!==i.content?!0:+new Date(h.created_at)<l);return c.find(h=>h.id===i.id)?c:[...c,i].sort((h,R)=>+new Date(h.created_at)-+new Date(R.created_at))}),!g.get(i.user_id)){const{data:a}=await m.from("profiles").select("user_id,id,name,avatar_url").eq("user_id",i.user_id).maybeSingle();a&&j(l=>new Map(l).set(a.user_id,a))}(()=>{const a=L.current;return a?a.scrollHeight-a.scrollTop-a.clientHeight<200:!0})()&&w.current?.scrollIntoView({behavior:"smooth",block:"end"})}).on("postgres_changes",{event:"INSERT",schema:"public",table:"group_message_reactions"},r=>{const s=r.new;U(i=>{const n=new Map(i),a=n.get(s.message_id)??{},l=a[s.emoji]??[];return l.includes(s.user_id)||l.push(s.user_id),a[s.emoji]=l,n.set(s.message_id,a),n})}).on("postgres_changes",{event:"DELETE",schema:"public",table:"group_message_reactions"},r=>{const s=r.old;U(i=>{const n=new Map(i),a=n.get(s.message_id)??{},l=(a[s.emoji]??[]).filter(c=>c!==s.user_id);return l.length?a[s.emoji]=l:delete a[s.emoji],n.set(s.message_id,a),n})}).on("postgres_changes",{event:"INSERT",schema:"public",table:"group_message_reads"},r=>{const s=r.new;V(i=>{const n=new Map(i),a=n.get(s.message_id)??[];return a.includes(s.user_id)||a.push(s.user_id),n.set(s.message_id,a),n})}).subscribe(),()=>{m.removeChannel(e)}},[o]),d.useEffect(()=>{const e=m.channel(`gm:${o}:presence`,{config:{presence:{key:f||Math.random().toString(36).slice(2)}}});return e.on("presence",{event:"sync"},()=>{const r=e.presenceState(),s=Object.keys(r);ne(s.length);let i=null;for(const n of s){const a=r[n],l=a[a.length-1];if(l?.typing&&l?.uid!==f){i=l.name||"Someone";break}}ae(i)}),e.subscribe(r=>{r==="SUBSCRIBED"&&e.track({uid:f,name:$?.name||(C?C.split("@")[0]:void 0),typing:!1})}),()=>{m.removeChannel(e)}},[o,f,$?.name]);const ce=async()=>{if(!Z||!G)return;const{data:e,error:r}=await m.from("group_messages").select("id,group_id,user_id:author_id,content,created_at,parent_id,attachments").eq("group_id",o).lt("created_at",Z).order("created_at",{ascending:!1}).limit(x);if(r){console.error(r);return}const s=(e??[]).reverse();s.length<x&&Y(!1),y(i=>[...s,...i])};d.useEffect(()=>{const e=m.channel("profiles-realtime").on("postgres_changes",{event:"*",schema:"public",table:"profiles"},r=>{const s=r.new;s?.user_id&&j(i=>{const n=new Map(i);return n.set(s.user_id,{user_id:s.user_id,id:s.user_id,name:s.name,avatar_url:s.avatar_url??null}),n})}).subscribe();return()=>{m.removeChannel(e)}},[]),d.useEffect(()=>{(async()=>{if(!p.length)return;const e=Array.from(new Set(p.map(i=>i.user_id))).filter(i=>!g.has(i));if(!e.length)return;const{data:r,error:s}=await m.from("profiles").select("user_id,id,name,avatar_url").in("user_id",e);s||r?.length&&j(i=>{const n=new Map(i);for(const a of r)n.set(a.user_id,a);return n})})()},[p,g]),d.useEffect(()=>{if(!f||!p.length)return;const e=L.current;if(!e)return;const r=new IntersectionObserver(async i=>{for(const n of i)if(n.isIntersecting){const a=n.target.dataset.mid;if(!a)continue;await m.from("group_message_reads").upsert({message_id:a,user_id:f},{onConflict:"message_id,user_id",ignoreDuplicates:!0})}},{root:e,threshold:.6});return e.querySelectorAll("[data-mid]").forEach(i=>r.observe(i)),()=>r.disconnect()},[f,p]);const ee=async()=>{const e=q.trim(),r=k?.id??null,s=f;if(!s||!e&&b.length===0||K||A)return;W(!0);const i=`phantom-${se()}`,n={id:i,group_id:o,user_id:s,content:e,created_at:new Date().toISOString(),parent_id:r,attachments:[]};y(c=>[...c,n]),w.current?.scrollIntoView({behavior:"smooth",block:"end"}),H(""),P(null);let a=[];if(b.length){O(!0);try{a=await Promise.all(b.map(async u=>{const h=`${o}/${xe(u)}`,{error:R}=await m.storage.from("chat-uploads").upload(h,u);if(R)throw R;const{data:he}=await m.storage.from("chat-uploads").createSignedUrl(h,3600*24*7);return{bucket:"chat-uploads",path:h,url:he?.signedUrl??null,name:u.name,size:u.size,type:u.type}}))}catch(c){console.error(c),O(!1);return}O(!1),M([])}const{error:l}=await m.rpc("send_group_message",{p_group_id:o,p_content:e});if(W(!1),l){y(c=>c.filter(u=>u.id!==i)),alert(l.message);return}w.current?.scrollIntoView({behavior:"smooth",block:"end"})};d.useEffect(()=>{(async()=>{if(!(!f||!o))try{await m.from("group_members").insert({group_id:o,user_id:f,role:"member"})}catch{}})()},[o,f]),d.useEffect(()=>{(async()=>{if(!(!f||!o))try{await m.rpc("mark_group_read",{p_group_id:o});try{window.dispatchEvent(new CustomEvent("group-read",{detail:{groupId:o}}))}catch{}await m.from("notifications").update({is_read:!0}).eq("user_id",f).eq("payload->>group_id",o).eq("is_read",!1)}catch{}})()},[o,f]),d.useEffect(()=>{if(!f||!o)return;const e=async()=>{try{await m.rpc("mark_group_read",{p_group_id:o});try{window.dispatchEvent(new CustomEvent("group-read",{detail:{groupId:o}}))}catch{}}catch{}};return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)},[o,f]);const E=async(e,r)=>{if(!f)return;(F.get(e)?.[r]??[]).includes(f)?await m.from("group_message_reactions").delete().eq("message_id",e).eq("user_id",f).eq("emoji",r):await m.from("group_message_reactions").insert({message_id:e,emoji:r})},D=e=>{if(e===f){const s=($?.name??"").trim();return s||(C?C.split("@")[0]:"You")}return(g.get(e)?.name??"").trim()||S.find(s=>s.user_id===e)?.name||"Player"},de=e=>{const r=g.get(e);if(r?.avatar_url)return t.jsx("img",{src:r.avatar_url,alt:"",className:"h-6 w-6 rounded-full object-cover"});const s=(r?.name||e.slice(0,2)).slice(0,2).toUpperCase();return t.jsx("div",{className:"h-6 w-6 rounded-full border flex items-center justify-center text-[10px]",children:s})},ue=e=>{e.preventDefault();const r=Array.from(e.dataTransfer?.files||[]);r.length&&M(s=>[...s,...r])},me=e=>{const r=[],s=Array.from(e.clipboardData?.items||[]);for(const i of s)if(i.kind==="file"){const n=i.getAsFile();n&&r.push(n)}r.length&&M(i=>[...i,...r])},fe=e=>e?.length?t.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:e.map((r,s)=>r?.type?.startsWith("image/")&&r.url?t.jsx("img",{src:r.url,alt:r.name||"",className:"max-h-40 rounded-lg border"},s):t.jsx("a",{href:r.url||"#",target:"_blank",rel:"noreferrer",className:"text-xs underline",children:r.name||r.path},s))}):null;return t.jsxs("div",{className:"relative flex h-full w-full max-h-[85vh] min-h-[420px] flex-col overflow-hidden rounded-3xl border shadow-2xl ring-1 ring-black/10 bg-gradient-to-br from-orange-400 via-rose-500 to-fuchsia-600 p-3 sm:p-4",children:[t.jsxs("div",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 -z-10 overflow-hidden",children:[t.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(255,255,255,0.25),transparent_35%),radial-gradient(circle_at_80%_0%,rgba(255,255,255,0.2),transparent_32%)]"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-white/10 via-transparent to-black/15 mix-blend-soft-light"})]}),t.jsxs("div",{className:"flex shrink-0 items-center justify-between rounded-2xl border border-white/20 bg-white/15 px-4 py-3 text-white backdrop-blur-md shadow-sm",children:[t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm font-bold drop-shadow-md",children:"Group Chat"}),t.jsx("div",{className:"text-[11px] opacity-90",children:J>0?`${J} online`:"Offline"})]}),t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[t.jsxs("button",{onClick:()=>oe(e=>!e),className:"rounded-full border border-white/30 bg-white/20 px-3 py-1 text-[11px] font-medium hover:bg-white/30 transition",title:"Show members",children:["Members (",S.length,")"]}),t.jsx("button",{onClick:v,className:"grid h-8 w-8 place-items-center rounded-full border border-white/30 bg-white/20 hover:bg-white/30 transition","aria-label":"Close chat",children:"âœ•"})]})]}),le&&t.jsxs("div",{className:"mt-2 rounded-2xl border border-white/40 bg-white/85 p-3 shadow-sm backdrop-blur-sm",children:[t.jsx("div",{className:"mb-1 text-xs font-semibold text-neutral-600",children:"Members"}),S.length===0?t.jsx("div",{className:"text-xs text-neutral-600",children:"No members yet."}):t.jsx("ul",{className:"grid grid-cols-2 gap-2 text-sm",children:S.map(e=>t.jsxs("li",{className:"flex items-center gap-2 rounded px-1 py-1 hover:bg-neutral-100",children:[e.avatar_url?t.jsx("img",{src:e.avatar_url,alt:"",className:"h-6 w-6 rounded-full object-cover"}):t.jsx("div",{className:"h-6 w-6 rounded-full border flex items-center justify-center text-[10px] text-neutral-600",children:(e.name||"").slice(0,2).toUpperCase()||"?"}),t.jsx("span",{className:"truncate text-neutral-800",children:e.name&&e.name.trim()||"Player"})]},e.user_id))})]}),t.jsx("div",{className:"mt-3 flex-1 overflow-hidden rounded-2xl border border-white/30 bg-white/85 shadow-xl backdrop-blur-sm",children:t.jsxs("div",{ref:L,className:"h-full overflow-y-auto p-3 sm:p-4",onDrop:ue,onDragOver:e=>e.preventDefault(),onClick:()=>_(null),children:[G&&t.jsx("div",{className:"mb-3 flex justify-center",children:t.jsx("button",{onClick:ce,disabled:z,className:"rounded-full border border-neutral-200 bg-white px-3 py-1 text-xs text-neutral-600 shadow-sm hover:bg-neutral-50 disabled:opacity-50",children:"Load older"})}),z&&p.length===0?t.jsx("div",{className:"flex h-full items-center justify-center text-sm text-neutral-500",children:"Loadingâ€¦"}):p.length===0?t.jsxs("div",{className:"flex h-full flex-col items-center justify-center gap-2 text-center text-sm text-neutral-600",children:[t.jsx("div",{className:"text-3xl",children:"ðŸ‘‹"}),t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-base font-semibold text-neutral-800",children:"No messages yet."}),t.jsx("div",{className:"text-xs text-neutral-500",children:"Be the first to say hi!"})]})]}):t.jsxs("ul",{className:"space-y-3",children:[p.map(e=>{const r=!!f&&e.user_id===f,s=F.get(e.id)??{},i=(re.get(e.id)??[]).filter(n=>n!==e.user_id).length;return t.jsxs("li",{className:`relative flex gap-2 ${r?"justify-end":""}`,"data-mid":e.id,children:[!r&&de(e.user_id),t.jsxs("div",{className:`flex max-w-[90%] sm:max-w-[85%] flex-col ${r?"items-end":"items-start"}`,children:[t.jsxs("div",{className:"flex w-full items-baseline gap-2",children:[t.jsx("span",{className:"text-xs font-semibold text-neutral-800",children:D(e.user_id)}),t.jsx("span",{className:"text-[10px] text-neutral-500",children:te(e.created_at)}),e.parent_id&&t.jsx("span",{className:"text-[10px] text-neutral-500",children:"(reply)"}),t.jsx("button",{onClick:n=>{n.stopPropagation(),_(X===e.id?null:e.id)},className:"ml-auto h-6 w-6 rounded-full text-xs leading-6 text-center text-neutral-500 hover:bg-neutral-100","aria-label":"More",title:"More",children:"â‹¯"})]}),X===e.id&&t.jsxs("div",{onClick:n=>n.stopPropagation(),className:"absolute right-2 top-6 z-20 w-36 rounded-md border bg-white shadow-md p-2 text-sm",children:[t.jsx("button",{className:"w-full text-left px-2 py-1 rounded hover:bg-neutral-100",onClick:()=>{P(e),_(null)},children:"Reply"}),t.jsx("div",{className:"my-1 border-t"}),t.jsxs("div",{className:"px-2 py-1",children:[t.jsx("div",{className:"mb-1 text-[11px] text-neutral-500",children:"Add reaction"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"text-base",onClick:()=>{E(e.id,"ðŸ‘"),_(null)},children:"ðŸ‘"}),t.jsx("button",{className:"text-base",onClick:()=>{E(e.id,"â¤ï¸"),_(null)},children:"â¤ï¸"}),t.jsx("button",{className:"text-base",onClick:()=>{E(e.id,"ðŸ˜‚"),_(null)},children:"ðŸ˜‚"})]})]})]}),e.parent_id&&(()=>{const n=p.find(a=>a.id===e.parent_id);return n?t.jsxs("div",{className:"mb-1 w-full rounded-md border border-neutral-200 bg-white px-2 py-1 text-[12px] text-neutral-700",children:["Replying to ",t.jsx("span",{className:"font-medium",children:D(n.user_id)}),": ",n.content.slice(0,120),n.content.length>120?"â€¦":""]}):null})(),t.jsx("div",{className:`whitespace-pre-wrap rounded-2xl px-3 py-2 text-sm shadow-sm ${r?"bg-gradient-to-r from-blue-500 to-indigo-500 text-white":"bg-neutral-100 text-neutral-900"}`,children:e.content}),t.jsx("div",{className:`mt-1 text-[10px] text-neutral-500 ${r?"text-right":"text-left"}`,children:te(e.created_at)}),fe(e.attachments),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2",children:[Object.entries(s).map(([n,a])=>{const l=f?a.includes(f):!1;return t.jsxs("button",{onClick:()=>E(e.id,n),className:`rounded-full border px-2 text-xs shadow-sm ${l?"bg-black text-white":"bg-white"}`,title:a.map(c=>D(c)).join(", "),children:[n," ",a.length]},n)}),t.jsx("div",{className:"flex items-center gap-1 text-[12px] text-neutral-500",children:i>0&&t.jsxs("span",{className:"text-[10px]",children:["Seen by ",i]})})]})]})]},e.id)}),t.jsx("div",{ref:w})]})]})}),Q&&t.jsxs("div",{className:"mt-1 text-xs text-white/85 italic",children:[Q," is typingâ€¦"]}),t.jsxs("div",{className:"mt-3 space-y-2 rounded-2xl border border-white/30 bg-white/90 p-3 shadow-lg backdrop-blur-sm",children:[k&&t.jsxs("div",{className:"flex items-center justify-between rounded-lg border border-neutral-200 bg-white px-3 py-2 text-xs text-neutral-700",children:[t.jsxs("div",{className:"truncate",children:["Replying to ",t.jsx("span",{className:"font-medium",children:D(k.user_id)})," â€” ",k.content.slice(0,80)]}),t.jsx("button",{onClick:()=>P(null),className:"ml-2 text-xs text-rose-500 underline",children:"cancel"})]}),b.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2 text-xs",children:b.map((e,r)=>t.jsxs("div",{className:"rounded-full border border-neutral-200 bg-white px-3 py-1 shadow-sm",children:[e.name," (",Math.round(e.size/1024)," KB)"]},r))}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{value:q,onChange:e=>H(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),ee())},onPaste:me,placeholder:"Message...",className:"flex-1 rounded-full border border-neutral-200 bg-white px-4 py-3 text-sm shadow-inner focus:outline-none focus:ring-2 focus:ring-rose-400/60",maxLength:4e3}),t.jsxs("label",{className:"grid h-11 w-11 place-items-center rounded-full border border-neutral-200 bg-white text-neutral-600 shadow-sm hover:bg-neutral-50 cursor-pointer",children:["ðŸ“Ž",t.jsx("input",{type:"file",multiple:!0,className:"hidden",onChange:e=>M(r=>[...r,...Array.from(e.target.files||[])])})]}),t.jsx("button",{onClick:ee,disabled:K||A||q.trim().length===0&&b.length===0,className:"flex h-11 w-11 items-center justify-center rounded-full bg-gradient-to-r from-rose-500 to-fuchsia-600 text-white shadow-lg transition-transform hover:scale-105 disabled:cursor-not-allowed disabled:opacity-60 disabled:scale-100",children:A?"â€¦":"âž¤"})]}),t.jsx("div",{className:"text-[11px] text-neutral-500",children:"Tip: drag & drop or paste images/files into the chat."})]})]})}export{je as default};
