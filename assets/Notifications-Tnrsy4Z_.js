import{c as D,u as P,j as t,s as c}from"./index-D94oHt45.js";import{i as R,c as d}from"./react-Dymf0t1b.js";import{C as U,a as F}from"./chevron-up-x5vG2fEs.js";import{U as G}from"./user-plus-DebHBzJu.js";import{M as O}from"./message-circle-C91JrA9O.js";import"./supabase-BesQZUkt.js";const V=[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]],z=D("mail",V);const J=[["path",{d:"M21 10.656V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.344",key:"2acyp4"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],B=D("square-check-big",J);function Z(){const x=R(),{user:u}=P(),[E,w]=d.useState(!0),[j,v]=d.useState([]),[N,y]=d.useState([]),[b,S]=d.useState([]),[q,C]=d.useState([]),[f,$]=d.useState(!1);d.useEffect(()=>{if(!u)return;const e=u.id;async function r(){w(!0);const n=new Date(Date.now()-336*60*60*1e3).toISOString();try{const{data:o}=await c.rpc("get_my_friend_requests"),s=(o||[]).map(l=>({id:l.id,user_id_a:l.sender_id,created_at:l.created_at,profiles:{name:l.sender_name,avatar_url:l.sender_avatar}})),{data:g}=await c.from("group_members").select("group_id, created_at, groups(title)").eq("user_id",e).eq("status","invited").gt("created_at",n),{data:_}=await c.from("group_members").select("group_id").eq("user_id",e).eq("status","active"),a=_?.map(l=>l.group_id)||[];let i=[],m=[];if(a.length>0){const{data:l}=await c.from("group_polls").select("id, title, group_id, created_at, groups(title)").in("group_id",a).eq("status","open").gt("created_at",n).order("created_at",{ascending:!1});i=l||[];const{data:I}=await c.from("group_messages").select("group_id, created_at, groups(title)").in("group_id",a).neq("user_id",e).gt("created_at",n).order("created_at",{ascending:!1}).limit(50);m=I||[]}v(s||[]),y(g||[]),S(i),C(m)}catch(o){console.error("Error loading notifications",o)}finally{w(!1)}}r()},[u]);const M=d.useMemo(()=>{const e=[],r=Date.now(),n=1440*60*1e3;j.forEach(a=>{e.push({id:`fr-${a.id}`,type:"friend_req",date:new Date(a.created_at),data:a})}),N.forEach(a=>{e.push({id:`inv-${a.group_id}`,type:"invite",date:new Date(a.created_at),data:a})});const o=new Map;b.forEach(a=>{o.has(a.id)||o.set(a.id,a)}),Array.from(o.values()).forEach(a=>{e.push({id:`poll-${a.id}`,type:"poll",date:new Date(a.created_at),data:a})});const s={};q.forEach(a=>{const i=a.group_id;s[i]||(s[i]={count:0,latest:new Date(a.created_at),groupName:a.groups?.title||"Unknown Group"}),s[i].count++;const m=new Date(a.created_at);m>s[i].latest&&(s[i].latest=m)}),Object.keys(s).forEach(a=>{e.push({id:`msg-group-${a}`,type:"message_summary",date:s[a].latest,data:{group_id:a,title:s[a].groupName,count:s[a].count}})}),e.sort((a,i)=>i.date.getTime()-a.date.getTime());const g=e.filter(a=>r-a.date.getTime()<n),_=e.filter(a=>r-a.date.getTime()>=n);return{recent:g,older:_}},[j,N,b,q]);async function A(e,r){await c.rpc("accept_friend",{from_id:r}),v(n=>n.filter(o=>o.id!==e))}async function L(e){u&&(await c.from("group_members").update({status:"active"}).eq("group_id",e).eq("user_id",u.id),y(r=>r.filter(n=>n.group_id!==e)),x(`/group/${e}`))}const k=e=>{const r=Date.now()-e.date.getTime()<864e5;return t.jsxs("div",{className:"bg-white border border-neutral-100 p-3 rounded-2xl flex items-center gap-3 shadow-sm mb-3 animate-in fade-in slide-in-from-bottom-2",children:[t.jsxs("div",{className:`h-10 w-10 shrink-0 rounded-full flex items-center justify-center ${e.type==="friend_req"?"bg-purple-100 text-purple-600":e.type==="invite"?"bg-amber-100 text-amber-600":e.type==="poll"?"bg-blue-100 text-blue-600":"bg-emerald-100 text-emerald-600"}`,children:[e.type==="friend_req"&&t.jsx(G,{className:"h-5 w-5"}),e.type==="invite"&&t.jsx(z,{className:"h-5 w-5"}),e.type==="poll"&&t.jsx(B,{className:"h-5 w-5"}),e.type==="message_summary"&&t.jsx(O,{className:"h-5 w-5"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[e.type==="friend_req"&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.profiles?.name||"User"}),t.jsx("div",{className:"text-xs text-neutral-500",children:"Sent you a friend request"}),t.jsx("div",{className:"mt-2 flex gap-2",children:t.jsx("button",{onClick:()=>A(e.data.id,e.data.user_id_a),className:"bg-black text-white px-3 py-1 rounded-full text-xs font-bold",children:"Accept"})})]}),e.type==="invite"&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.groups?.title}),t.jsx("div",{className:"text-xs text-neutral-500",children:"You were invited to join"}),t.jsx("div",{className:"mt-2 flex gap-2",children:t.jsx("button",{onClick:()=>L(e.data.group_id),className:"bg-black text-white px-3 py-1 rounded-full text-xs font-bold",children:"Join"})})]}),e.type==="poll"&&t.jsxs("div",{onClick:()=>x(`/group/${e.data.group_id}`),className:"cursor-pointer",children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.title}),t.jsxs("div",{className:"text-xs text-neutral-500 flex items-center gap-1",children:["Vote in ",t.jsx("span",{className:"font-medium text-neutral-700",children:e.data.groups?.title})]})]}),e.type==="message_summary"&&t.jsxs("div",{onClick:()=>x(`/group/${e.data.group_id}`),className:"cursor-pointer",children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.title}),t.jsxs("div",{className:"text-xs text-neutral-500 font-medium",children:[e.data.count," new message",e.data.count>1?"s":""]})]})]}),t.jsx("div",{className:"text-[10px] text-neutral-400 whitespace-nowrap self-start",children:r?e.date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):e.date.toLocaleDateString()})]},e.id)};if(E)return t.jsx("div",{className:"pt-24 text-center text-neutral-400 text-sm",children:"Checking for updates..."});const{recent:h,older:p}=M,T=h.length===0&&p.length===0;return t.jsxs("div",{className:"mx-auto w-full max-w-xl px-4 py-8 pb-32",children:[t.jsx("h1",{className:"text-2xl font-extrabold text-neutral-900 mb-6",children:"Activity"}),T&&t.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[t.jsx("div",{className:"h-16 w-16 bg-neutral-100 rounded-full flex items-center justify-center mb-4",children:t.jsx("span",{className:"text-2xl",children:"ðŸ’¤"})}),t.jsx("h3",{className:"text-neutral-900 font-bold",children:"All caught up"}),t.jsx("p",{className:"text-neutral-500 text-sm",children:"No new notifications in the last 2 weeks."})]}),h.length>0&&t.jsxs("div",{className:"mb-6",children:[t.jsx("h2",{className:"text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3",children:"New"}),h.map(k)]}),p.length>0&&t.jsxs("div",{children:[t.jsxs("button",{onClick:()=>$(!f),className:"flex items-center gap-2 text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3 hover:text-neutral-600 transition-colors w-full",children:[f?t.jsx(U,{className:"h-4 w-4"}):t.jsx(F,{className:"h-4 w-4"}),"Earlier (",p.length,")"]}),f&&t.jsx("div",{className:"animate-in slide-in-from-top-2 fade-in duration-300",children:p.map(k)})]})]})}export{Z as default};
