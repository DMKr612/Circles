import{c as q,u as I,j as t,s as d}from"./index-CckTKZT9.js";import{i as P,c as l}from"./react-Dymf0t1b.js";import{C as U,a as F}from"./chevron-up-CxOCiwgE.js";import{U as G}from"./user-plus-cL3LHSgz.js";import{M as O}from"./message-circle-Bhv2c0-o.js";import"./supabase-BesQZUkt.js";const R=[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]],V=q("mail",R);const z=[["path",{d:"M21 10.656V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.344",key:"2acyp4"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],J=q("square-check-big",z);function X(){const x=P(),{user:u}=I(),[D,_]=l.useState(!0),[w,j]=l.useState([]),[v,N]=l.useState([]),[b,E]=l.useState([]),[y,S]=l.useState([]),[f,C]=l.useState(!1);l.useEffect(()=>{if(!u)return;const e=u.id;async function n(){_(!0);const a=new Date(Date.now()-336*60*60*1e3).toISOString();try{const{data:o}=await d.from("friendships").select("id, user_id_a, created_at, profiles!friendships_user_id_a_fkey(name, avatar_url)").eq("user_id_b",e).eq("status","pending").gt("created_at",a),{data:r}=await d.from("group_members").select("group_id, created_at, groups(title)").eq("user_id",e).eq("status","invited").gt("created_at",a),{data:g}=await d.from("group_members").select("group_id").eq("user_id",e).eq("status","active"),m=g?.map(c=>c.group_id)||[];let s=[],i=[];if(m.length>0){const{data:c}=await d.from("group_polls").select("id, title, group_id, created_at, groups(title)").in("group_id",m).eq("status","open").gt("created_at",a).order("created_at",{ascending:!1});s=c||[];const{data:T}=await d.from("group_messages").select("group_id, created_at, groups(title)").in("group_id",m).neq("user_id",e).gt("created_at",a).order("created_at",{ascending:!1}).limit(50);i=T||[]}j(o||[]),N(r||[]),E(s),S(i)}catch(o){console.error("Error loading notifications",o)}finally{_(!1)}}n()},[u]);const $=l.useMemo(()=>{const e=[],n=Date.now(),a=1440*60*1e3;w.forEach(s=>{e.push({id:`fr-${s.id}`,type:"friend_req",date:new Date(s.created_at),data:s})}),v.forEach(s=>{e.push({id:`inv-${s.group_id}`,type:"invite",date:new Date(s.created_at),data:s})});const o=new Map;b.forEach(s=>{o.has(s.id)||o.set(s.id,s)}),Array.from(o.values()).forEach(s=>{e.push({id:`poll-${s.id}`,type:"poll",date:new Date(s.created_at),data:s})});const r={};y.forEach(s=>{const i=s.group_id;r[i]||(r[i]={count:0,latest:new Date(s.created_at),groupName:s.groups?.title||"Unknown Group"}),r[i].count++;const c=new Date(s.created_at);c>r[i].latest&&(r[i].latest=c)}),Object.keys(r).forEach(s=>{e.push({id:`msg-group-${s}`,type:"message_summary",date:r[s].latest,data:{group_id:s,title:r[s].groupName,count:r[s].count}})}),e.sort((s,i)=>i.date.getTime()-s.date.getTime());const g=e.filter(s=>n-s.date.getTime()<a),m=e.filter(s=>n-s.date.getTime()>=a);return{recent:g,older:m}},[w,v,b,y]);async function M(e,n){await d.rpc("accept_friend",{from_id:n}),j(a=>a.filter(o=>o.id!==e))}async function A(e){u&&(await d.from("group_members").update({status:"active"}).eq("group_id",e).eq("user_id",u.id),N(n=>n.filter(a=>a.group_id!==e)),x(`/group/${e}`))}const k=e=>{const n=Date.now()-e.date.getTime()<864e5;return t.jsxs("div",{className:"bg-white border border-neutral-100 p-3 rounded-2xl flex items-center gap-3 shadow-sm mb-3 animate-in fade-in slide-in-from-bottom-2",children:[t.jsxs("div",{className:`h-10 w-10 shrink-0 rounded-full flex items-center justify-center ${e.type==="friend_req"?"bg-purple-100 text-purple-600":e.type==="invite"?"bg-amber-100 text-amber-600":e.type==="poll"?"bg-blue-100 text-blue-600":"bg-emerald-100 text-emerald-600"}`,children:[e.type==="friend_req"&&t.jsx(G,{className:"h-5 w-5"}),e.type==="invite"&&t.jsx(V,{className:"h-5 w-5"}),e.type==="poll"&&t.jsx(J,{className:"h-5 w-5"}),e.type==="message_summary"&&t.jsx(O,{className:"h-5 w-5"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[e.type==="friend_req"&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.profiles?.name||"User"}),t.jsx("div",{className:"text-xs text-neutral-500",children:"Sent you a friend request"}),t.jsx("div",{className:"mt-2 flex gap-2",children:t.jsx("button",{onClick:()=>M(e.data.id,e.data.user_id_a),className:"bg-black text-white px-3 py-1 rounded-full text-xs font-bold",children:"Accept"})})]}),e.type==="invite"&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.groups?.title}),t.jsx("div",{className:"text-xs text-neutral-500",children:"You were invited to join"}),t.jsx("div",{className:"mt-2 flex gap-2",children:t.jsx("button",{onClick:()=>A(e.data.group_id),className:"bg-black text-white px-3 py-1 rounded-full text-xs font-bold",children:"Join"})})]}),e.type==="poll"&&t.jsxs("div",{onClick:()=>x(`/group/${e.data.group_id}`),className:"cursor-pointer",children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.title}),t.jsxs("div",{className:"text-xs text-neutral-500 flex items-center gap-1",children:["Vote in ",t.jsx("span",{className:"font-medium text-neutral-700",children:e.data.groups?.title})]})]}),e.type==="message_summary"&&t.jsxs("div",{onClick:()=>x(`/group/${e.data.group_id}`),className:"cursor-pointer",children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.title}),t.jsxs("div",{className:"text-xs text-neutral-500 font-medium",children:[e.data.count," new message",e.data.count>1?"s":""]})]})]}),t.jsx("div",{className:"text-[10px] text-neutral-400 whitespace-nowrap self-start",children:n?e.date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):e.date.toLocaleDateString()})]},e.id)};if(D)return t.jsx("div",{className:"pt-24 text-center text-neutral-400 text-sm",children:"Checking for updates..."});const{recent:h,older:p}=$,L=h.length===0&&p.length===0;return t.jsxs("div",{className:"mx-auto w-full max-w-xl px-4 py-8 pb-32",children:[t.jsx("h1",{className:"text-2xl font-extrabold text-neutral-900 mb-6",children:"Activity"}),L&&t.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[t.jsx("div",{className:"h-16 w-16 bg-neutral-100 rounded-full flex items-center justify-center mb-4",children:t.jsx("span",{className:"text-2xl",children:"ðŸ’¤"})}),t.jsx("h3",{className:"text-neutral-900 font-bold",children:"All caught up"}),t.jsx("p",{className:"text-neutral-500 text-sm",children:"No new notifications in the last 2 weeks."})]}),h.length>0&&t.jsxs("div",{className:"mb-6",children:[t.jsx("h2",{className:"text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3",children:"New"}),h.map(k)]}),p.length>0&&t.jsxs("div",{children:[t.jsxs("button",{onClick:()=>C(!f),className:"flex items-center gap-2 text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3 hover:text-neutral-600 transition-colors w-full",children:[f?t.jsx(U,{className:"h-4 w-4"}):t.jsx(F,{className:"h-4 w-4"}),"Earlier (",p.length,")"]}),f&&t.jsx("div",{className:"animate-in slide-in-from-top-2 fade-in duration-300",children:p.map(k)})]})]})}export{X as default};
