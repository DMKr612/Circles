import{u as Q,s as x,j as e}from"./index-CckTKZT9.js";import{c as n,L as E,u as K}from"./react-Dymf0t1b.js";import"./supabase-BesQZUkt.js";const F=12,X=new Set(["games","study","outdoors"]);function Y({category:o,search:j}){const{user:k}=Q(),s=k?.id||null,[w,y]=n.useState([]),[L,v]=n.useState(!1),[q,f]=n.useState(null),[S,G]=n.useState(0),[$,B]=n.useState(!1),[t,N]=n.useState(!1),[I,T]=n.useState({}),[D,H]=n.useState({}),[R,U]=n.useState({}),O=!0,V=!0;n.useEffect(()=>{let r=!0;return(async()=>{const{data:i,error:a}=await x.from("allowed_games").select("id, category").eq("is_active",!0);if(!r)return;if(a){U({});return}const c={};(i??[]).forEach(g=>{const h=String(g.category||"").toLowerCase(),b=String(g.id||"").toLowerCase();!h||!b||(c[h]||(c[h]=[]),c[h].push(b))}),U(c)})(),()=>{r=!1}},[]);const _=n.useCallback(async r=>{try{if(!s||!r.length)return;const{data:i,error:a}=await x.from("group_reads").select("group_id,last_read_at").eq("user_id",s).in("group_id",r);if(a)throw a;const c={};(i??[]).forEach(d=>{c[d.group_id]=d.last_read_at??null});const g=r.map(async d=>{const C=c[d]??"1970-01-01T00:00:00Z",{count:A,error:M}=await x.from("group_messages").select("id",{count:"exact",head:!0}).eq("group_id",d).gt("created_at",C);return M?[d,0]:[d,A??0]}),h=await Promise.all(g),b={};h.forEach(([d,C])=>{b[d]=C}),H(d=>({...d,...b}))}catch{}},[s]),Z=n.useCallback(async r=>{if(s)try{await x.rpc("mark_group_read",{p_group_id:r}),H(i=>({...i,[r]:0})),await x.from("notifications").update({is_read:!0}).eq("user_id",s).eq("payload->>group_id",r).eq("is_read",!1)}catch(i){console.warn("[markGroupRead]",i)}},[s]);n.useEffect(()=>{if(!s)return;const r=x.channel(`reads:${s}`).on("postgres_changes",{event:"*",schema:"public",table:"group_reads",filter:`user_id=eq.${s}`},async i=>{const a=i.new?.group_id||i.old?.group_id;a&&await _([a])}).subscribe();return()=>{x.removeChannel(r)}},[s,_]),n.useEffect(()=>{if(!s)return;const r=()=>{const c=w.map(g=>g.id);c.length&&_(c)};window.addEventListener("focus",r);const i=()=>{document.visibilityState==="visible"&&r()};document.addEventListener("visibilitychange",i);const a=window.setInterval(r,2e4);return()=>{window.removeEventListener("focus",r),document.removeEventListener("visibilitychange",i),window.clearInterval(a)}},[s,w,_]);const P=n.useCallback(async(r,i)=>{try{if(i?(v(!0),y([]),G(0),B(!1)):N(!0),f(null),(O||V)&&!s){y([]),f("Please sign in to view your groups."),v(!1),N(!1);return}if(!s){y([]),f("Please sign in to view your groups."),v(!1),N(!1);return}let a=[];const c=r*F,g=c+F-1,[h,b]=await Promise.all([x.from("group_members").select("group_id").eq("user_id",s),x.from("groups").select("id").eq("host_id",s)]);if(h.error)throw h.error;if(b.error)throw b.error;const d=(h.data??[]).map(u=>u.group_id),C=(b.data??[]).map(u=>u.id),A=new Set([...d,...C]),M=Array.from(A),W=u=>{let m=u;const l=o?o.toLowerCase():"";if(l)if(X.has(l)){const p=R[l]??[];if(p.length>0){const J=p.join(",");m=m.or(`game.in.(${J}),category.eq.${l}`)}else m=m.eq("category",l)}else{const p=l.replace(/[^a-z0-9]+/g,"");m=m.or(`game.eq.${p},game.ilike.*${l}*,title.ilike.*${l}*`)}if(j.trim()){const p=j.trim();m=m.or(`title.ilike.*${p}*,game.ilike.*${p}*`)}return m};if(M.length>0){let u=x.from("groups").select("id, title, description, city, capacity, category, game, created_at, host_id").in("id",M).order("created_at",{ascending:!1}).range(c,g);const{data:m,error:l}=await W(u);if(l)throw l;a=m??[]}else a=[];if(y(i?a:u=>[...u,...a]),G(r),B(a.length===F),(a??[]).length>0){const u=a.map(p=>p.id);s&&u.length>0&&await _(u);const{data:m}=await x.from("group_polls").select("group_id").in("group_id",u).eq("status","open"),l={};(m??[]).forEach(p=>{l[p.group_id]=!0}),T(p=>({...p,...l}))}}catch(a){f(a?.message??"Failed to load groups")}finally{v(!1),N(!1)}},[s,o,j,R,_]);n.useEffect(()=>{s&&P(0,!0)},[s,o,j,R,P]);const z=n.useCallback(async()=>{if(!s||t)return;const r=S+1;await P(r,!1)},[s,S,t,P]);return{me:s,groups:w,loading:L,err:q,hasMore:$,paging:t,unreadCounts:D,openPolls:I,loadMore:z,markGroupRead:Z}}function ee(o){if(!o)return"";try{return new Date(o).toLocaleDateString()}catch{return""}}function te(){const o=K();return n.useMemo(()=>new URLSearchParams(o.search),[o.search])}function ne(){const o=te(),j=o.get("category")||"",k=o.get("q")||"",{me:s,groups:w,loading:y,err:L,hasMore:v,paging:q,unreadCounts:f,openPolls:S,loadMore:G,markGroupRead:$}=Y({category:j,search:k});return e.jsxs("main",{className:"mx-auto max-w-5xl px-4 py-8",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"My Groups"}),k&&e.jsxs("p",{className:"text-sm text-neutral-600",children:["Filtered by: “",k,"”"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{to:"/browse",className:"text-sm underline",children:"Back"}),e.jsx(E,{to:"/create",className:"rounded-md bg-emerald-700 px-3 py-1.5 text-sm text-white hover:brightness-110",children:"New Group"})]})]}),e.jsx("div",{className:"mt-6 rounded-2xl border border-black/10 bg-white/90 p-5 shadow-sm backdrop-blur",children:y&&w.length===0?e.jsx("ul",{className:"divide-y divide-black/5",children:Array.from({length:6}).map((t,N)=>e.jsxs("li",{className:"rounded-xl border border-black/10 bg-white p-4 shadow-sm",children:[e.jsx("div",{className:"h-5 w-48 animate-pulse rounded bg-neutral-200"}),e.jsx("div",{className:"mt-2 h-3 w-5/6 animate-pulse rounded bg-neutral-200"}),e.jsx("div",{className:"mt-1 h-3 w-2/3 animate-pulse rounded bg-neutral-200"}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("div",{className:"h-8 w-24 animate-pulse rounded bg-neutral-200"}),e.jsx("div",{className:"h-8 w-28 animate-pulse rounded bg-neutral-200"})]})]},N))}):L?e.jsx("div",{className:"rounded-lg border border-red-200 bg-red-50 p-4 text-red-800",children:L}):w.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 p-10 text-center text-neutral-600",children:[e.jsxs("svg",{width:"36",height:"36",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"opacity-70",children:[e.jsx("path",{d:"M8 21h8"}),e.jsx("path",{d:"M12 17v4"}),e.jsx("path",{d:"M7 3h10l4 7H3l4-7Z"})]}),e.jsx("div",{className:"text-lg font-medium",children:"No groups found"}),e.jsx("div",{className:"text-sm",children:"Try a different filter or create a new one."}),e.jsxs("div",{className:"mt-2 flex justify-center gap-2",children:[e.jsx(E,{to:"/browse",className:"rounded-md border border-black/10 bg-white px-3 py-1.5 text-sm hover:bg-black/[0.04]",children:"Back"}),e.jsx(E,{to:"/create",className:"rounded-md bg-emerald-700 px-3 py-1.5 text-sm text-white hover:brightness-110",children:"New Group"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("ul",{className:"divide-y divide-black/5",children:w.map(t=>e.jsx("li",{className:"group py-1 first:pt-0 last:pb-0",children:e.jsx("div",{className:"flex items-center",children:e.jsx(E,{to:`/group/${t.id}`,onClick:()=>$(t.id),className:"block flex-1 rounded-lg px-2 py-2 hover:bg-black/[0.03] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-9 w-9 select-none items-center justify-center rounded-full border border-black/10 bg-neutral-100 text-sm font-semibold text-neutral-700",children:(t.title||t.game||"G").slice(0,1).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"truncate text-base font-medium text-neutral-900",children:t.title??"Untitled group"}),t.host_id&&t.host_id===s&&e.jsx("span",{className:"shrink-0 rounded-full border border-amber-300 bg-amber-50 px-2 py-0.5 text-[11px] text-amber-800",children:"Host"})]}),e.jsx("div",{className:"mt-0.5 line-clamp-1 text-xs text-neutral-600",children:t.description??"No description"}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-1 text-[11px] text-neutral-700",children:[t.category&&e.jsxs("span",{className:"rounded-full border border-black/10 bg-neutral-50 px-2 py-0.5",children:["#",t.category]}),t.game&&e.jsx("span",{className:"rounded-full border border-black/10 bg-neutral-50 px-2 py-0.5",children:t.game}),t.city&&e.jsx("span",{className:"rounded-full border border-black/10 bg-neutral-50 px-2 py-0.5",children:t.city}),t.capacity&&e.jsxs("span",{className:"rounded-full border border-black/10 bg-neutral-50 px-2 py-0.5",children:[t.capacity," slots"]}),t.created_at&&e.jsx("span",{className:"rounded-full border border-black/10 bg-neutral-50 px-2 py-0.5",children:ee(t.created_at)})]})]}),e.jsxs("div",{className:"ml-1 flex items-center gap-1",children:[S[t.id]&&e.jsx("span",{className:"inline-flex h-6 items-center justify-center rounded-full bg-blue-600 px-2 text-xs font-semibold text-white",title:"Open voting","aria-label":"Open voting",children:"Vote"}),typeof f[t.id]=="number"&&f[t.id]>0&&e.jsx("span",{className:"inline-flex h-6 min-w-[1.5rem] items-center justify-center rounded-full bg-emerald-600 px-1 text-xs font-semibold text-white",title:`${f[t.id]} new messages`,"aria-label":`${f[t.id]} new messages`,children:f[t.id]>99?"99+":f[t.id]})]})]})})})},t.id))}),v&&e.jsx("div",{className:"mt-5 border-t border-black/5 p-4 text-center",children:e.jsx("button",{onClick:G,className:"inline-flex items-center gap-2 rounded-md border border-black/10 bg-white px-3 py-1.5 text-sm hover:bg-black/[0.04]",disabled:q,children:q?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"h-4 w-4 animate-spin",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]}),"Loading…"]}):e.jsx(e.Fragment,{children:"Load more"})})})]})})]})}export{ne as default};
