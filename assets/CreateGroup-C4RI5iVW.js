import{s as c,j as t,_ as Ce}from"./index-BFSOJQ8p.js";import{c as r,i as Ne,L as _e}from"./react-Dymf0t1b.js";import"./supabase-BesQZUkt.js";function Se(p,M){const C=p.trim().toLowerCase();if(!C)return null;const A=M.find(N=>N.toLowerCase()===C);return A||(M.find(N=>N.toLowerCase().startsWith(C))??null)}function Ge(){const[p,M]=r.useState([]),[C,A]=r.useState(!1),N=async()=>{if(C||p.length>0)return;const{State:e,City:s}=await Ce(async()=>{const{State:m,City:i}=await import("./index-D7rQSa_G.js");return{State:m,City:i}},[]),a=e.getStatesOfCountry("DE")||[],n=[];for(const m of a){const i=s.getCitiesOfState("DE",m.isoCode)||[];for(const f of i)f&&typeof f.name=="string"&&f.name.trim()&&n.push(f.name.trim())}const o=Array.from(new Set(n)).sort((m,i)=>m.localeCompare(i,"de"));M(o),A(!0)},V=Ne(),$="Games",de="",[y,ue]=r.useState([]),[g,me]=r.useState([]),[_,H]=r.useState(!0),[Le,xe]=r.useState(""),[b,K]=r.useState([]),[ke,W]=r.useState(!0),[S,Ee]=r.useState([]),[J,qe]=r.useState("");r.useMemo(()=>new Map(b.map(e=>[e.id,e])),[b]),r.useMemo(()=>new Set(b.map(e=>e.id)),[b]),r.useMemo(()=>{const e=J.trim().toLowerCase();return e?b.filter(s=>(s.display_name||"").toLowerCase().includes(e)||(s.id||"").toLowerCase().includes(e)):b},[b,J]);async function fe(e){W(!0);try{const[s,a]=await Promise.all([c.from("friends").select("friend_id").eq("user_id",e).eq("status","accepted"),c.from("friends").select("user_id").eq("friend_id",e).eq("status","accepted")]),n=[];!s.error&&Array.isArray(s.data)&&n.push(...s.data.map(l=>l.friend_id).filter(Boolean)),!a.error&&Array.isArray(a.data)&&n.push(...a.data.map(l=>l.user_id).filter(Boolean));const o=Array.from(new Set(n));if(o.length===0){const I=await c.from("profiles").select("id, user_id, display_name, name, avatar_url").neq("id",e).neq("user_id",e).limit(12),je=(!I.error&&Array.isArray(I.data)?I.data:[]).map(D=>({id:D.id||D.user_id,display_name:(D.display_name||D.name)??null,avatar_url:D.avatar_url??null}));K(je);return}const m="id, user_id, display_name, name, avatar_url";let i=[];const f=await c.from("profiles").select(m).in("id",o);if(!f.error&&f.data?.length)i=f.data;else{const l=await c.from("profiles").select(m).in("user_id",o);!l.error&&l.data?.length&&(i=l.data)}const ve=(i||[]).map(l=>({id:l.id||l.user_id,display_name:(l.display_name||l.name)??null,avatar_url:l.avatar_url??null})).filter(l=>o.includes(l.id));K(ve)}finally{W(!1)}}r.useEffect(()=>{let e=!0;return(async()=>{const{data:s,error:a}=await c.auth.getUser();if(!e)return;const n=a?void 0:s?.user?.id;n&&(xe(n),await fe(n))})(),()=>{e=!1}},[]),r.useEffect(()=>{let e=!0;return(async()=>{H(!0);const{data:s}=await c.from("allowed_categories").select("name").eq("is_active",!0),{data:a}=await c.from("allowed_games").select("id, name, category").eq("is_active",!0);e&&(ue((s??[]).map(n=>({name:n.name}))),me((a??[]).map(n=>({id:n.id,label:n.name||n.id,category:n.category}))),H(!1))})(),()=>{e=!1}},[]),r.useEffect(()=>{function e(s){const a=s.target,n=document.getElementById("cat-combobox"),o=document.getElementById("game-combobox");n&&!n.contains(a)&&B(!1),o&&!o.contains(a)&&F(!1)}return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const[L,pe]=r.useState(""),[G,ge]=r.useState(""),[w,P]=r.useState(""),[T,X]=r.useState(!1),v=r.useMemo(()=>Se(w,p),[w,p]),j=!!v,[R,k]=r.useState(!1),[E,O]=r.useState(-1),q=r.useMemo(()=>{const e=w.trim().toLowerCase();return e?p.filter(s=>s.toLowerCase().includes(e)).slice(0,8):p.slice(0,8)},[w,p]),[x,Y]=r.useState(3),[Z,B]=r.useState(!1),[U,ee]=r.useState(""),[d,te]=r.useState("");r.useEffect(()=>{if(!y.length)return;const e=String($),s=y.find(a=>a.name.toLowerCase()===e.toLowerCase());te((s?.name||y[0].name).toLowerCase())},[y,$]);const[se,F]=r.useState(!1),[Q,ae]=r.useState(""),[h,z]=r.useState("");r.useEffect(()=>{if(!g.length||!d)return;const e="".toLowerCase().replace(/\s+/g,""),s=g.find(a=>a.id===e||a.label.toLowerCase().replace(/\s+/g,"")===e);s&&z(s.id)},[g,de,d]);const re=r.useMemo(()=>{const e=U.trim().toLowerCase(),s=y.map(a=>a.name);return e?s.filter(a=>a.toLowerCase().includes(e)):s},[U,y]),ne=r.useMemo(()=>{const e=g.filter(a=>a.category.toLowerCase()===(d||"").toLowerCase()),s=Q.trim().toLowerCase();return s?e.filter(a=>a.label.toLowerCase().includes(s)||a.id.includes(s)):e},[d,Q,g]),ie=!_&&L.trim().length>0&&d&&h&&x>=3&&x<=16&&j,[u,le]=r.useState(1),oe=L.trim().length>0&&!!d&&!!h,ce=j&&x>=3&&x<=16;function he(){u===1&&!oe||u===2&&!ce||le(e=>Math.min(3,e+1))}function be(){le(e=>Math.max(1,e-1))}async function ye(e,s){if(S.length){try{const{error:a}=await c.rpc("send_group_invites",{p_group_id:e,p_recipient_ids:S});if(!a){console.debug("[CreateGroup] send_group_invites RPC ok",{groupId:e,inviteeCount:S.length});return}console.warn("[CreateGroup] send_group_invites RPC failed, will fallback",a?.message)}catch(a){console.warn("[CreateGroup] send_group_invites RPC threw, will fallback",a)}try{const a=S.map(o=>({group_id:e,inviter_id:s,recipient_id:o,status:"pending"})),{error:n}=await c.from("group_invitations").insert(a);n&&console.warn("[CreateGroup] group_invitations insert failed",n.message)}catch{}try{let a=null;try{const{data:i}=await c.from("groups").select("title").eq("id",e).maybeSingle();a=i?.title??null}catch{}let n=null;try{const{data:i}=await c.from("profiles").select("display_name,name").in("id",[s]).maybeSingle();n=i?.display_name||i?.name||null}catch{}const o=S.map(i=>({user_id:i,kind:"group_invite",payload:{group_id:e,group_title:a,inviter_id:s,inviter_name:n},is_read:!1})),{error:m}=await c.from("notifications").insert(o);m&&console.warn("[CreateGroup] notifications insert likely blocked by RLS (expected). Use RPC send_group_invites.",m.message)}catch{}}}async function we(){if(!ie)return;if(!j){X(!0);return}const{data:e,error:s}=await c.auth.getUser();if(s||!e?.user?.id){alert(s?.message||"Sign in required");return}const a=e.user.id,n=Math.max(3,Math.min(16,x)),o=v??null,m={title:L.trim(),description:G.trim().replace(/\s+$/,"")||null,category:(d||"").toLowerCase(),game:h,city:o,capacity:n,visibility:"public",host_id:a},{data:i,error:f}=await c.from("groups").insert([m]).select("id").maybeSingle();if(f){alert(String(f.message??"Unknown error"));return}if(!i?.id){alert("Group created but ID missing. Try refreshing.");return}ye(i.id,a),V(`/group/${i.id}`)}return t.jsx("div",{className:"min-h-screen bg-neutral-50",children:t.jsxs("div",{className:"mx-auto w-full max-w-xl px-4 pb-10 pt-6",children:[t.jsxs("div",{className:"mb-6 flex items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-semibold tracking-tight",children:"Start a new Circle"}),t.jsx("p",{className:"mt-1 text-sm text-neutral-600",children:"A small, calm group for the right people. 3 quick steps."})]}),t.jsx(_e,{to:"/browse",className:"shrink-0 rounded-full border border-neutral-200 px-3 py-1.5 text-xs font-medium text-neutral-700 hover:bg-neutral-100",children:"Back"})]}),t.jsx("div",{className:"mb-6 flex items-center justify-between text-xs font-medium text-neutral-600",children:[{id:1,label:"Basics"},{id:2,label:"Location"},{id:3,label:"Details"}].map(e=>{const s=u===e.id,a=u>e.id;return t.jsxs("div",{className:"flex flex-1 items-center gap-2",children:[t.jsx("div",{className:["flex h-7 w-7 items-center justify-center rounded-full border text-[11px]",s?"border-emerald-600 bg-emerald-600 text-white":a?"border-emerald-400 bg-emerald-50 text-emerald-700":"border-neutral-300 bg-white text-neutral-500"].join(" "),children:e.id}),t.jsx("span",{className:s?"text-neutral-900":"text-neutral-500",children:e.label})]},e.id)})}),t.jsxs("div",{className:"space-y-4",children:[u===1&&t.jsxs("section",{className:"rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm",children:[t.jsx("h2",{className:"mb-3 text-sm font-semibold text-neutral-800",children:"Basics"}),_&&t.jsx("div",{className:"mb-2 text-xs text-neutral-500",children:"Loading categoriesâ€¦"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Title"}),t.jsx("input",{value:L,onChange:e=>pe(e.target.value),placeholder:"e.g., Friday Night Hokm",className:"mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Category"}),t.jsxs("div",{id:"cat-combobox",className:"relative mt-1",children:[t.jsx("input",{value:Z?U:d||"",onChange:e=>{B(!0),ee(e.target.value)},onFocus:()=>B(!0),placeholder:"Search or choose categoryâ€¦",className:"w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30",disabled:_}),Z&&t.jsxs("div",{className:"absolute z-20 mt-1 max-h-56 w-full overflow-auto rounded-lg border bg-white shadow-lg",children:[re.length===0&&t.jsx("div",{className:"px-3 py-2 text-sm text-neutral-500",children:"No matches"}),re.map(e=>t.jsx("button",{type:"button",onClick:()=>{te(e.toLowerCase()),B(!1),ee(""),g.some(s=>s.category===e&&s.id===h)||z("")},className:"block w-full px-3 py-2 text-left text-sm hover:bg-neutral-50",children:e},e))]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Game / Activity"}),t.jsxs("div",{id:"game-combobox",className:"relative mt-1",children:[t.jsx("input",{value:se?Q:g.find(e=>e.category.toLowerCase()===(d||"").toLowerCase()&&e.id===h)?.label||"",onChange:e=>{F(!0),ae(e.target.value)},onFocus:()=>F(!0),placeholder:"Search or choose game/activityâ€¦",className:"w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30",disabled:_||!(d&&d.trim().length>0)}),se&&t.jsxs("div",{className:"absolute z-20 mt-1 max-h-56 w-full overflow-auto rounded-lg border bg-white shadow-lg",children:[ne.length===0&&t.jsx("div",{className:"px-3 py-2 text-sm text-neutral-500",children:"No matches"}),ne.map(e=>t.jsx("button",{type:"button",onClick:()=>{z(e.id),F(!1),ae("")},className:"block w-full px-3 py-2 text-left text-sm hover:bg-neutral-50",children:e.label},e.id))]})]})]})]})]}),u===2&&t.jsxs("section",{className:"rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm",children:[t.jsx("h2",{className:"mb-3 text-sm font-semibold text-neutral-800",children:"Location & size"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"relative",children:[t.jsxs("label",{className:"block text-xs font-medium text-neutral-700",children:["City ",t.jsx("span",{className:"text-red-600",children:"*"})]}),t.jsx("input",{value:w,onChange:e=>{P(e.target.value),k(!0),O(-1)},onFocus:async()=>{await N(),k(!0)},onBlur:()=>{setTimeout(()=>k(!1),120),X(!0)},onKeyDown:e=>{R&&(e.key==="ArrowDown"?(e.preventDefault(),O(s=>Math.min(q.length-1,s+1))):e.key==="ArrowUp"?(e.preventDefault(),O(s=>Math.max(-1,s-1))):e.key==="Enter"&&E>=0&&q[E]&&(e.preventDefault(),P(q[E]),k(!1)))},placeholder:"Start typingâ€¦ e.g., Offenburg",className:["mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30",T&&!j?"border-red-400 focus:border-red-500":""].join(" "),"aria-autocomplete":"list","aria-expanded":R,"aria-controls":"city-suggest",role:"combobox"}),R&&q.length>0&&t.jsx("div",{id:"city-suggest",className:"absolute z-20 mt-1 max-h-64 w-full overflow-auto rounded-lg border border-neutral-200 bg-white shadow-lg",role:"listbox",children:q.map((e,s)=>t.jsx("button",{type:"button",onMouseDown:a=>a.preventDefault(),onClick:()=>{P(e),k(!1),O(-1)},className:["flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-emerald-50",s===E?"bg-emerald-50":""].join(" "),role:"option","aria-selected":s===E,children:t.jsx("span",{className:"truncate",children:e})},e+s))}),!j&&T&&t.jsx("p",{className:"mt-1 text-xs text-red-600",children:"Choose a city from suggestions."}),j&&T&&v!==w&&t.jsxs("p",{className:"mt-1 text-xs text-neutral-500",children:["Using â€œ",v,"â€."]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Capacity"}),t.jsx("div",{className:"mt-1 flex items-center gap-3",children:t.jsx("input",{type:"number",value:x===0?"":x,onChange:e=>{const s=e.target.value;if(s===""){Y(0);return}const a=Number(s);Y(a)},placeholder:"3â€“16",className:"w-24 rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30"})}),(x<3||x>16)&&x!==0&&t.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Capacity must be between 3 and 16."})]})]})]}),u===3&&t.jsxs("section",{className:"rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm",children:[t.jsx("h2",{className:"mb-3 text-sm font-semibold text-neutral-800",children:"Details & preview"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Description"}),t.jsx("textarea",{value:G,onChange:e=>ge(e.target.value),placeholder:"Tell people what this circle is aboutâ€¦",rows:4,className:"mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30"})]}),t.jsxs("div",{className:"rounded-xl border border-dashed border-neutral-200 bg-neutral-50 p-3 text-xs text-neutral-700",children:[t.jsx("div",{className:"mb-1 text-[11px] font-semibold uppercase tracking-wide text-neutral-500",children:"Preview"}),t.jsx("div",{className:"text-sm font-semibold text-neutral-900",children:L||"Untitled Circle"}),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-neutral-600",children:[d&&t.jsx("span",{className:"rounded-full bg-white px-2 py-0.5",children:d}),h&&t.jsx("span",{className:"rounded-full bg-white px-2 py-0.5",children:g.find(e=>e.id===h)?.label||h}),v&&t.jsxs("span",{className:"rounded-full bg-white px-2 py-0.5 flex items-center gap-1",children:[t.jsx("span",{children:"ðŸ“"}),v]}),t.jsxs("span",{className:"rounded-full bg-white px-2 py-0.5",children:[x," spots"]})]}),G&&t.jsx("p",{className:"mt-2 line-clamp-3 text-xs text-neutral-700",children:G})]})]})]})]}),t.jsxs("div",{className:"mt-6 flex items-center justify-between gap-3",children:[t.jsx("button",{type:"button",onClick:u===1?()=>V("/browse"):be,className:"rounded-full border border-neutral-200 px-3 py-1.5 text-xs font-medium text-neutral-700 hover:bg-neutral-100",children:u===1?"Cancel":"Back"}),t.jsxs("div",{className:"flex gap-2",children:[u<3&&t.jsx("button",{type:"button",onClick:he,disabled:u===1&&!oe||u===2&&!ce||_,className:"rounded-full bg-emerald-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 disabled:opacity-60",children:"Next"}),u===3&&t.jsx("button",{type:"button",disabled:!ie,onClick:we,className:"rounded-full bg-emerald-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 disabled:opacity-60",children:"Create Circle"})]})]})]})})}export{Ge as default};
