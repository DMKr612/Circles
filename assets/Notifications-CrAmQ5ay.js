import{c as C,u as V,j as t,s as d}from"./index-Dxv4Wk-w.js";import{i as I,c as n}from"./react-Dymf0t1b.js";import{C as O,a as z}from"./chevron-up-B7VhiFCL.js";import{U as H}from"./user-plus-Dv7v8Idp.js";import{M as J}from"./message-circle-BPpCCv7q.js";import"./supabase-BesQZUkt.js";const Y=[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]],B=C("mail",Y);const K=[["path",{d:"M21 10.656V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.344",key:"2acyp4"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],E=C("square-check-big",K);function ae(){const p=I(),{user:c}=V(),[D,_]=n.useState(!0),[v,j]=n.useState([]),[N,y]=n.useState([]),[b,S]=n.useState([]),[w,T]=n.useState([]),[q,M]=n.useState([]),[x,P]=n.useState(!1);n.useEffect(()=>{if(!c)return;const e=c.id;async function r(){_(!0);try{const{data:i}=await d.rpc("get_my_friend_requests"),s=(i||[]).map(l=>({id:l.id,user_id_a:l.sender_id,created_at:l.created_at,profiles:{name:l.sender_name,avatar_url:l.sender_avatar}})),{data:f}=await d.from("group_members").select("group_id, created_at, groups(title)").eq("user_id",e).eq("status","invited").order("created_at",{ascending:!1}),{data:h}=await d.from("group_members").select("group_id").eq("user_id",e).eq("status","accepted"),a=h?.map(l=>l.group_id)||[];let o=[],u=[],$=[];if(a.length>0){const{data:l}=await d.from("group_polls").select("id, title, group_id, created_at, groups(title)").in("group_id",a).eq("status","open").order("created_at",{ascending:!1});o=l||[];const{data:R}=await d.from("group_messages").select("group_id, created_at, groups(title)").in("group_id",a).neq("sender_id",e).order("created_at",{ascending:!1}).limit(50);u=R||[];const{data:U}=await d.from("group_votes").select("poll_id, option_id, created_at, group_polls(id, title, group_id, groups(title)), group_poll_options(id, label)").eq("user_id",e).order("created_at",{ascending:!1}).limit(200);$=U||[]}j(s||[]),y(f||[]),S(o),T(u),M($)}catch(i){console.error("Error loading notifications",i)}finally{_(!1)}}r()},[c]);const A=n.useMemo(()=>{const e=[],r=new Date;r.setHours(0,0,0,0),v.forEach(a=>{e.push({id:`fr-${a.id}`,type:"friend_req",date:new Date(a.created_at),data:a})}),N.forEach(a=>{e.push({id:`inv-${a.group_id}`,type:"invite",date:new Date(a.created_at),data:a})});const i=new Map;b.forEach(a=>{i.has(a.id)||i.set(a.id,a)}),Array.from(i.values()).forEach(a=>{e.push({id:`poll-${a.id}`,type:"poll",date:new Date(a.created_at),data:a})});const s={};w.forEach(a=>{const o=a.group_id;s[o]||(s[o]={count:0,latest:new Date(a.created_at),groupName:a.groups?.title||"Unknown Group"}),s[o].count++;const u=new Date(a.created_at);u>s[o].latest&&(s[o].latest=u)}),Object.keys(s).forEach(a=>{e.push({id:`msg-group-${a}`,type:"message_summary",date:s[a].latest,data:{group_id:a,title:s[a].groupName,count:s[a].count}})}),q.forEach(a=>{e.push({id:`vote-${a.poll_id}-${a.option_id}-${a.created_at}`,type:"vote",date:new Date(a.created_at),data:a})}),e.sort((a,o)=>o.date.getTime()-a.date.getTime());const f=e.filter(a=>a.date.getTime()>=r.getTime()),h=e.filter(a=>a.date.getTime()<r.getTime());return{recent:f,older:h}},[v,N,b,w,q]);async function L(e,r){await d.rpc("accept_friend",{from_id:r}),j(i=>i.filter(s=>s.id!==e))}async function F(e){if(!c)return;const{error:r}=await d.from("group_members").update({status:"accepted"}).eq("group_id",e).eq("user_id",c.id);if(r){console.error("Failed to join group from notifications",r);return}y(i=>i.filter(s=>s.group_id!==e)),p(`/group/${e}`)}const k=e=>{const r=Date.now()-e.date.getTime()<864e5;return t.jsxs("div",{className:"bg-white border border-neutral-100 p-3 rounded-2xl flex items-center gap-3 shadow-sm mb-3 animate-in fade-in slide-in-from-bottom-2",children:[t.jsxs("div",{className:`h-10 w-10 shrink-0 rounded-full flex items-center justify-center ${e.type==="friend_req"?"bg-purple-100 text-purple-600":e.type==="invite"?"bg-amber-100 text-amber-600":e.type==="poll"?"bg-blue-100 text-blue-600":(e.type==="vote","bg-emerald-100 text-emerald-600")}`,children:[e.type==="friend_req"&&t.jsx(H,{className:"h-5 w-5"}),e.type==="invite"&&t.jsx(B,{className:"h-5 w-5"}),e.type==="poll"&&t.jsx(E,{className:"h-5 w-5"}),e.type==="vote"&&t.jsx(E,{className:"h-5 w-5"}),e.type==="message_summary"&&t.jsx(J,{className:"h-5 w-5"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[e.type==="friend_req"&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.profiles?.name||"User"}),t.jsx("div",{className:"text-xs text-neutral-500",children:"Sent you a friend request"}),t.jsx("div",{className:"mt-2 flex gap-2",children:t.jsx("button",{onClick:()=>L(e.data.id,e.data.user_id_a),className:"bg-black text-white px-3 py-1 rounded-full text-xs font-bold",children:"Accept"})})]}),e.type==="invite"&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.groups?.title}),t.jsx("div",{className:"text-xs text-neutral-500",children:"You were invited to join"}),t.jsx("div",{className:"mt-2 flex gap-2",children:t.jsx("button",{onClick:()=>F(e.data.group_id),className:"bg-black text-white px-3 py-1 rounded-full text-xs font-bold",children:"Join"})})]}),e.type==="poll"&&t.jsxs("div",{onClick:()=>p(`/group/${e.data.group_id}`),className:"cursor-pointer",children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.title}),t.jsxs("div",{className:"text-xs text-neutral-500 flex items-center gap-1",children:["Vote in ",t.jsx("span",{className:"font-medium text-neutral-700",children:e.data.groups?.title})]})]}),e.type==="vote"&&t.jsxs("div",{onClick:()=>p(`/group/${e.data.group_polls?.group_id||e.data.group_polls?.group_id}`),className:"cursor-pointer",children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:"You voted"}),t.jsx("div",{className:"text-xs text-neutral-500",children:e.data.group_polls?.title?`Poll: ${e.data.group_polls.title}`:"Poll"}),t.jsx("div",{className:"text-xs text-neutral-500",children:e.data.group_poll_options?.label?`Choice: ${e.data.group_poll_options.label}`:""}),t.jsx("div",{className:"text-xs text-neutral-500",children:e.data.group_polls?.groups?.title?`Group: ${e.data.group_polls.groups.title}`:""})]}),e.type==="message_summary"&&t.jsxs("div",{onClick:()=>p(`/group/${e.data.group_id}`),className:"cursor-pointer",children:[t.jsx("div",{className:"text-sm font-bold text-neutral-900",children:e.data.title}),t.jsxs("div",{className:"text-xs text-neutral-500 font-medium",children:[e.data.count," new message",e.data.count>1?"s":""]})]})]}),t.jsx("div",{className:"text-[10px] text-neutral-400 whitespace-nowrap self-start",children:r?e.date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):e.date.toLocaleDateString()})]},e.id)};if(D)return t.jsx("div",{className:"pt-24 text-center text-neutral-400 text-sm",children:"Checking for updates..."});const{recent:g,older:m}=A,G=g.length===0&&m.length===0;return t.jsxs("div",{className:"mx-auto w-full max-w-xl px-4 py-8 pb-32",children:[t.jsx("h1",{className:"text-2xl font-extrabold text-neutral-900 mb-6",children:"Activity"}),G&&t.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[t.jsx("div",{className:"h-16 w-16 bg-neutral-100 rounded-full flex items-center justify-center mb-4",children:t.jsx("span",{className:"text-2xl",children:"ðŸ’¤"})}),t.jsx("h3",{className:"text-neutral-900 font-bold",children:"All caught up"}),t.jsx("p",{className:"text-neutral-500 text-sm",children:"No activity yet."})]}),g.length>0&&t.jsxs("div",{className:"mb-6",children:[t.jsx("h2",{className:"text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3",children:"New"}),g.map(k)]}),m.length>0&&t.jsxs("div",{children:[t.jsxs("button",{onClick:()=>P(!x),className:"flex items-center gap-2 text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3 hover:text-neutral-600 transition-colors w-full",children:[x?t.jsx(O,{className:"h-4 w-4"}):t.jsx(z,{className:"h-4 w-4"}),"Earlier (",m.length,")"]}),x&&t.jsx("div",{className:"animate-in slide-in-from-top-2 fade-in duration-300",children:m.map(k)})]})]})}export{ae as default};
