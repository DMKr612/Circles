import{u as F,s as c,j as e}from"./index-BFSOJQ8p.js";import{f as K,c as r,L as A}from"./react-Dymf0t1b.js";import{A as H}from"./arrow-left-PSsh7f_2.js";import{S as V}from"./search-DcCgcw5G.js";import{M as W}from"./map-pin-B0hwBbkr.js";import{C as X}from"./clock-B85n2gcQ.js";import"./supabase-BesQZUkt.js";function Y(l){if(!l)return"";try{return new Date(l).toLocaleDateString()}catch{return""}}function N(l){if(!l)return"";try{return l.normalize("NFKD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim()}catch{return l.toLowerCase().trim()}}function le(){const{user:l}=F(),v=l?.id||null,{game:S=""}=K(),C=(S||"").toLowerCase().replace(/[^a-z0-9]+/g,"").trim(),x=(S||"").replace(/-/g," ").trim(),[d,O]=r.useState([]),[q,f]=r.useState(null),[z,_]=r.useState(!0),[k,G]=r.useState(new Set),[L,M]=r.useState(null),[p,B]=r.useState("new"),[h,$]=r.useState({}),[b,I]=r.useState(""),[o,J]=r.useState("all"),[i,g]=r.useState(null),[R,y]=r.useState(!1);async function P(){try{y(!0);const{data:t}=await c.auth.getUser(),a=t?.user?.id??null;if(!a){g(null),y(!1);return}const{data:s}=await c.from("profiles").select("city").eq("user_id",a).maybeSingle(),n=s?.city||null,u=n&&typeof n=="string"?n.trim():null;g(u)}catch{g(null)}finally{y(!1)}}r.useEffect(()=>{let t=!0;return(async()=>{_(!0);let a=c.from("groups").select("*").order("created_at",{ascending:!1}).limit(100);a=a.or(`game_slug.eq.${C},game.ilike.${x}`);const{data:s,error:n}=await a;if(t){if(n)f(n.message);else{const u=s??[];O(u);try{const m=u.map(w=>w.id).filter(Boolean);if(m.length){const w=new Date(Date.now()-3e5).toISOString(),{data:T}=await c.from("group_reads").select("group_id").in("group_id",m).gt("last_read_at",w),j={};(T??[]).forEach(U=>{const E=String(U.group_id);j[E]=(j[E]??0)+1}),$(j)}}catch(m){console.warn(m)}}_(!1)}})(),()=>{t=!1}},[C,x]);async function Q(t){if(!v){f("Sign in required");return}M(t);const{error:a}=await c.from("group_members").insert({group_id:t,user_id:v,role:"member"});if(M(null),!a||a.code==="23505"){const s=new Set(k);s.add(t),G(s)}else f(a.message)}const D=r.useMemo(()=>{let t=[...d];if(o==="mine"&&i){const s=N(i);t=t.filter(n=>N(n.city).includes(s))}const a=b.trim().toLowerCase();return a&&(t=t.filter(s=>N(s.city).includes(a)||s.code&&s.code.toLowerCase().includes(a)||s.title&&s.title.toLowerCase().includes(a))),p==="online"?t.sort((s,n)=>(h[n.id]??0)-(h[s.id]??0)):t.sort((s,n)=>new Date(n.created_at??"").getTime()-new Date(s.created_at??"").getTime()),t},[d,o,i,b,p,h]);return r.useEffect(()=>{o==="mine"&&!i&&!R&&P()},[o]),e.jsxs("main",{className:"mx-auto max-w-3xl px-4 py-6 pb-32",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(A,{to:"/browse",className:"flex h-8 w-8 items-center justify-center rounded-full bg-neutral-100 hover:bg-neutral-200 transition-colors",children:e.jsx(H,{className:"h-4 w-4 text-neutral-700"})}),e.jsx("span",{className:"text-sm font-semibold text-neutral-500 uppercase tracking-wider",children:"Game"})]}),e.jsx("h1",{className:"text-3xl font-extrabold tracking-tight text-neutral-900 capitalize",children:x}),e.jsxs("p",{className:"mt-2 text-neutral-600",children:[d.length," active group",d.length!==1&&"s"," found."]})]}),e.jsxs("div",{className:"sticky top-0 z-20 mb-6 flex flex-col gap-3 bg-neutral-50/95 py-2 backdrop-blur-sm sm:flex-row sm:items-center",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(V,{className:"absolute left-3 top-2.5 h-4 w-4 text-neutral-400"}),e.jsx("input",{value:b,onChange:t=>I(t.target.value),placeholder:"Search city, title, or code...",className:"w-full rounded-xl border border-neutral-200 bg-white py-2 pl-9 pr-4 text-sm outline-none focus:border-black focus:ring-1 focus:ring-black"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:o,onChange:t=>J(t.target.value),className:"rounded-xl border border-neutral-200 bg-white px-3 py-2 text-sm font-medium outline-none focus:border-black",children:[e.jsx("option",{value:"all",children:"All Cities"}),e.jsxs("option",{value:"mine",children:["My City ",i?`(${i})`:""]})]}),e.jsxs("select",{value:p,onChange:t=>B(t.target.value),className:"rounded-xl border border-neutral-200 bg-white px-3 py-2 text-sm font-medium outline-none focus:border-black",children:[e.jsx("option",{value:"new",children:"Newest"}),e.jsx("option",{value:"online",children:"Active"})]})]})]}),e.jsx("ul",{className:"space-y-3",children:D.map(t=>e.jsx("li",{className:"group relative overflow-hidden rounded-2xl border border-neutral-100 bg-white p-4 shadow-sm transition-all hover:shadow-md active:scale-[0.99]",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h2",{className:"truncate text-base font-bold text-neutral-900",children:t.title||"Untitled Group"}),t.is_online&&e.jsx("span",{className:"inline-flex items-center rounded-full bg-blue-50 px-2 py-0.5 text-[10px] font-bold text-blue-700 border border-blue-100",children:"ONLINE"})]}),e.jsx("p",{className:"line-clamp-1 text-sm text-neutral-600 mb-3",children:t.description||"No description"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-neutral-500 font-medium",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(W,{className:"h-3 w-3"}),t.city||"Anywhere"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(X,{className:"h-3 w-3"}),Y(t.created_at)]}),t.code&&e.jsxs("span",{className:"rounded-md bg-neutral-100 px-1.5 py-0.5 font-mono text-neutral-600",children:["#",t.code]})]})]}),e.jsx("div",{className:"flex flex-col items-end gap-2",children:k.has(t.id)?e.jsx(A,{to:`/group/${t.id}`,className:"rounded-full border border-neutral-200 bg-white px-4 py-1.5 text-xs font-bold text-neutral-900 hover:bg-neutral-50 transition-colors",children:"Open"}):e.jsx("button",{onClick:()=>Q(t.id),disabled:L===t.id,className:"rounded-full bg-black px-4 py-1.5 text-xs font-bold text-white shadow-sm hover:bg-neutral-800 disabled:opacity-50 transition-all",children:L===t.id?"Joining...":"Join"})})]})},t.id))}),!z&&!q&&D.length===0&&e.jsx("div",{className:"py-10 text-center text-neutral-500",children:"No groups found."})]})}export{le as default};
