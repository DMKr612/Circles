const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatPanel-DGttmwed.js","assets/index-DSWsW7ob.js","assets/react-Dymf0t1b.js","assets/supabase-BesQZUkt.js","assets/index-Cc7FYaoN.css"])))=>i.map(i=>d[i]);
import{c as A,j as e,s as c,U as R,M as q,_ as G}from"./index-DSWsW7ob.js";import{i as H,u as O,c as l}from"./react-Dymf0t1b.js";import{V as B}from"./ViewOtherProfileModal-CloLoggu.js";import{S as K}from"./search-fGs_fQBd.js";import{A as W}from"./arrow-left-DuVweI1p.js";import"./supabase-BesQZUkt.js";import"./x-B5KYdqRP.js";import"./user-plus-8ZMcCG99.js";const J=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],Q=A("funnel",J);const X=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Y=A("send",X);function D({size:h=20,className:p=""}){return e.jsxs("svg",{className:`animate-spin ${p}`,width:h,height:h,viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]})}const Z=l.lazy(()=>G(()=>import("./ChatPanel-DGttmwed.js"),__vite__mapDeps([0,1,2,3,4])));function de(){const h=H(),p=O(),[o,P]=l.useState(null),[g,y]=l.useState([]),[N,z]=l.useState(!0),[s,m]=l.useState(null),[_,C]=l.useState(null),[v,k]=l.useState([]),[x,S]=l.useState(""),[$,M]=l.useState(!1),w=l.useRef(null),[b,F]=l.useState("all"),[E,T]=l.useState("");l.useEffect(()=>{async function t(){const{data:{user:r}}=await c.auth.getUser();if(!r)return;P(r.id);const{data:a}=await c.from("group_members").select("group_id, groups(id, title, category)").eq("user_id",r.id).eq("status","active"),{data:n}=await c.from("friendships").select("user_id_a, user_id_b").or(`user_id_a.eq.${r.id},user_id_b.eq.${r.id}`).eq("status","accepted"),d=[];if(a&&a.forEach(i=>{i.groups&&d.push({type:"group",id:i.groups.id,name:i.groups.title,avatar_url:null,subtitle:i.groups.category||"Group"})}),n){const i=n.map(u=>u.user_id_a===r.id?u.user_id_b:u.user_id_a);if(i.length>0){const{data:u}=await c.from("profiles").select("user_id, name, avatar_url").in("user_id",i);u?.forEach(f=>{d.push({type:"dm",id:f.user_id,name:f.name||"User",avatar_url:f.avatar_url,subtitle:"Direct Message"})})}}d.sort((i,u)=>i.name.localeCompare(u.name)),y(d),z(!1)}t()},[]),l.useEffect(()=>{const t=p.state?.openDmId;if(t&&g.length>0&&!s){const r=g.find(a=>a.id===t&&a.type==="dm");r?m(r):(async()=>{const{data:a}=await c.from("profiles").select("name, avatar_url").eq("user_id",t).single();if(a){const n={type:"dm",id:t,name:a.name||"User",avatar_url:a.avatar_url,subtitle:"Direct Message"};y(d=>[n,...d]),m(n)}})(),window.history.replaceState({},"")}},[p.state,g,s]),l.useEffect(()=>{if(!o||!s||s.type!=="dm")return;let t=null;async function r(){M(!0);const a=s.id,{data:n}=await c.from("direct_messages").select("*").or(`and(from_id.eq.${o},to_id.eq.${a}),and(from_id.eq.${a},to_id.eq.${o})`).order("created_at",{ascending:!0}).limit(100);k(n||[]),M(!1),setTimeout(()=>w.current?.scrollIntoView({behavior:"smooth"}),100),t=c.channel(`dm:${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"direct_messages"},d=>{const i=d.new;(i.from_id===o&&i.to_id===a||i.from_id===a&&i.to_id===o)&&(k(f=>[...f,i]),setTimeout(()=>w.current?.scrollIntoView({behavior:"smooth"}),100))}).subscribe()}return r(),()=>{t&&c.removeChannel(t)}},[s,o]);const L=async()=>{if(!x.trim()||!o||!s||s.type!=="dm")return;const t=x.trim();S(""),await c.from("direct_messages").insert({from_id:o,to_id:s.id,body:t})},I=g.filter(t=>!(b==="groups"&&t.type!=="group"||b==="private"&&t.type!=="dm"||b==="fav"&&!t.isFavorite||!t.name.toLowerCase().includes(E.toLowerCase()))),j=({id:t,label:r})=>e.jsx("button",{onClick:()=>F(t),className:`
        whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-semibold transition-all border
        ${b===t?"bg-neutral-900 text-white border-neutral-900 shadow-md transform scale-105":"bg-white text-neutral-600 border-neutral-200 hover:bg-neutral-50 hover:border-neutral-300"}
      `,children:r}),U=()=>e.jsxs("div",{className:`flex flex-col h-full bg-white border-r border-neutral-200 ${s?"hidden md:flex":"flex"} w-full md:w-80 lg:w-96`,children:[e.jsxs("div",{className:"p-5 border-b border-neutral-100 bg-white/80 backdrop-blur-md sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-neutral-900 tracking-tight",children:"Chats"}),N&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-neutral-900"})]}),e.jsxs("div",{className:"relative mb-4 group",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-neutral-400 group-focus-within:text-emerald-600 transition-colors",children:e.jsx(K,{className:"h-4 w-4"})}),e.jsx("input",{value:E,onChange:t=>T(t.target.value),placeholder:"Search conversations...",className:"block w-full pl-10 pr-3 py-2.5 border border-neutral-200 rounded-xl leading-5 bg-neutral-50 placeholder-neutral-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm font-medium"})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1 scrollbar-hide",children:[e.jsx(j,{id:"all",label:"All"}),e.jsx(j,{id:"groups",label:"Groups"}),e.jsx(j,{id:"private",label:"Private"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:N?e.jsx("div",{className:"p-8 flex justify-center",children:e.jsx(D,{})}):I.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-neutral-400 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-neutral-50 rounded-full flex items-center justify-center mb-4",children:e.jsx(Q,{className:"h-6 w-6 opacity-30"})}),e.jsx("p",{className:"text-sm font-medium",children:"No chats found."}),e.jsx("p",{className:"text-xs mt-1 opacity-70",children:"Try adjusting your filters or search."})]}):e.jsx("div",{className:"px-2 py-2 space-y-1",children:I.map(t=>e.jsxs("button",{onClick:()=>m(t),className:`
                  w-full flex items-center gap-3 p-3 rounded-xl text-left transition-all duration-200
                  ${s?.id===t.id?"bg-emerald-50 shadow-sm ring-1 ring-emerald-100":"hover:bg-neutral-50"}
                `,children:[e.jsx("div",{className:`
                  h-12 w-12 rounded-full flex items-center justify-center text-lg font-bold shrink-0 shadow-sm
                  ${t.type==="group"?"bg-gradient-to-br from-indigo-100 to-indigo-200 text-indigo-700":"bg-gradient-to-br from-neutral-100 to-neutral-200 text-neutral-600"}
                `,children:t.type==="dm"&&t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:"",className:"h-full w-full object-cover rounded-full"}):t.type==="group"?e.jsx(R,{className:"h-5 w-5"}):t.name.slice(0,1).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:`font-semibold truncate ${s?.id===t.id?"text-emerald-900":"text-neutral-900"}`,children:t.name}),e.jsx("div",{className:"text-xs text-neutral-500 truncate mt-0.5",children:t.subtitle})]})]},t.type+t.id))})})]}),V=()=>{if(!s)return e.jsxs("div",{className:"hidden md:flex flex-1 items-center justify-center bg-neutral-50/50 flex-col gap-6",children:[e.jsx("div",{className:"bg-white p-6 rounded-full shadow-sm ring-1 ring-black/5",children:e.jsx(q,{className:"h-12 w-12 text-emerald-500/50"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900",children:"Select a conversation"}),e.jsx("p",{className:"text-sm text-neutral-500 mt-1",children:"Choose a group or friend to start chatting"})]})]});const t=()=>{s.type==="group"?h(`/group/${s.id}`):s.type==="dm"&&C(s.id)};return e.jsxs("div",{className:"fixed inset-0 z-50 pb-20 md:pb-0 md:static md:inset-auto md:flex-1 bg-white flex flex-col h-full",children:[e.jsxs("div",{className:"h-[72px] border-b border-neutral-200 flex items-center px-4 gap-4 bg-white/95 backdrop-blur-sm shrink-0 shadow-sm z-20",children:[e.jsx("button",{onClick:()=>m(null),className:"md:hidden p-2 -ml-2 rounded-full hover:bg-neutral-100 transition-colors",children:e.jsx(W,{className:"h-5 w-5 text-neutral-600"})}),e.jsxs("div",{onClick:t,className:"flex items-center gap-4 flex-1 min-w-0 cursor-pointer hover:opacity-70 transition-opacity",title:`View ${s.type==="group"?"Group":"Profile"}`,children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center text-sm font-bold shadow-sm ${s.type==="group"?"bg-indigo-100 text-indigo-700":"bg-neutral-100 text-neutral-600"}`,children:s.type==="dm"&&s.avatar_url?e.jsx("img",{src:s.avatar_url,alt:"",className:"h-full w-full object-cover rounded-full"}):s.type==="group"?"#":s.name.slice(0,1)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-bold text-neutral-900 truncate text-base",children:s.name}),e.jsxs("div",{className:"text-xs text-neutral-500 flex items-center gap-1",children:[e.jsx("span",{className:`w-1.5 h-1.5 rounded-full ${s.type==="group"?"bg-indigo-500":"bg-emerald-500"}`}),s.type==="group"?"Group Chat":"Direct Message"]})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden relative bg-neutral-50",children:[e.jsx("div",{className:"absolute inset-0 opacity-[0.03] pointer-events-none",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='1'/%3E%3C/g%3E%3C/svg%3E")`}}),s.type==="group"?e.jsx(l.Suspense,{fallback:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx(D,{})}),children:e.jsx("div",{className:"h-full w-full relative z-10",children:e.jsx(Z,{groupId:s.id,onClose:()=>m(null),full:!0,setFull:()=>{},user:{id:o}})})}):e.jsxs("div",{className:"flex flex-col h-full relative z-10",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[$&&e.jsx("div",{className:"flex justify-center py-4",children:e.jsx("div",{className:"bg-white/80 px-4 py-1.5 rounded-full text-xs font-medium text-neutral-500 shadow-sm border border-neutral-100",children:"Loading history..."})}),!$&&v.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-neutral-400 space-y-3",children:[e.jsx("div",{className:"w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center",children:e.jsx(q,{className:"h-8 w-8 text-neutral-200"})}),e.jsx("div",{className:"text-sm",children:"No messages yet. Say hi! ðŸ‘‹"})]}),v.map((r,a)=>{const n=r.from_id===o,d=!n&&(a===0||v[a-1].from_id!==r.from_id);return e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"} group animate-in fade-in slide-in-from-bottom-2 duration-300`,children:e.jsxs("div",{className:`flex max-w-[80%] md:max-w-[70%] ${n?"flex-row-reverse":"flex-row"} items-end gap-2`,children:[!n&&e.jsx("div",{className:"w-6 h-6 shrink-0 mb-1",children:d&&(s.avatar_url?e.jsx("img",{src:s.avatar_url,className:"w-6 h-6 rounded-full object-cover shadow-sm"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 flex items-center justify-center text-[9px] font-bold text-neutral-500",children:s.name.slice(0,1)}))}),e.jsxs("div",{className:`
                          px-4 py-2.5 text-sm shadow-sm relative
                          ${n?"bg-gradient-to-br from-emerald-500 to-emerald-600 text-white rounded-2xl rounded-tr-sm":"bg-white text-neutral-800 border border-neutral-100 rounded-2xl rounded-tl-sm"}
                        `,children:[r.body,e.jsx("div",{className:`text-[9px] mt-1 text-right opacity-70 ${n?"text-emerald-100":"text-neutral-400"}`,children:new Date(r.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},r.id)}),e.jsx("div",{ref:w})]}),e.jsx("div",{className:"p-4 bg-white border-t border-neutral-200/80 backdrop-blur-md",children:e.jsxs("div",{className:"flex items-center gap-2 max-w-4xl mx-auto bg-neutral-50 border border-neutral-200 rounded-full px-2 py-2 focus-within:ring-2 focus-within:ring-emerald-500/20 focus-within:border-emerald-500 transition-all shadow-inner",children:[e.jsx("input",{value:x,onChange:r=>S(r.target.value),onKeyDown:r=>r.key==="Enter"&&L(),placeholder:"Type a message...",className:"flex-1 bg-transparent border-0 px-4 py-1 text-sm focus:ring-0 text-neutral-900 placeholder-neutral-400 outline-none"}),e.jsx("button",{onClick:L,disabled:!x.trim(),className:`
                      p-2.5 rounded-full transition-all duration-200 flex items-center justify-center shadow-sm
                      ${x.trim()?"bg-emerald-600 text-white hover:bg-emerald-700 hover:scale-105 active:scale-95":"bg-neutral-200 text-neutral-400 cursor-not-allowed"}
                    `,children:e.jsx(Y,{className:"h-4 w-4 ml-0.5"})})]})})]})]})]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex h-[calc(100vh-64px)] w-full overflow-hidden bg-white fixed top-0 left-0",children:[e.jsx(U,{}),e.jsx(V,{})]}),e.jsx(B,{isOpen:!!_,onClose:()=>C(null),viewUserId:_})]})}export{de as default};
