import{s as o,j as t,_ as Ce}from"./index-Buqi4C9v.js";import{c as r,i as Ne,L as _e}from"./react-Dymf0t1b.js";import"./supabase-BesQZUkt.js";function Se(p,E){const C=p.trim().toLowerCase();if(!C)return null;const A=E.find(N=>N.toLowerCase()===C);return A||(E.find(N=>N.toLowerCase().startsWith(C))??null)}function Oe(){const[p,E]=r.useState([]),[C,A]=r.useState(!1),N=async()=>{if(C||p.length>0)return;const{State:e,City:s}=await Ce(async()=>{const{State:u,City:i}=await import("./index-D7rQSa_G.js");return{State:u,City:i}},[]),a=e.getStatesOfCountry("DE")||[],n=[];for(const u of a){const i=s.getCitiesOfState("DE",u.isoCode)||[];for(const f of i)f&&typeof f.name=="string"&&f.name.trim()&&n.push(f.name.trim())}const m=Array.from(new Set(n)).sort((u,i)=>u.localeCompare(i,"de"));E(m),A(!0)},$=Ne(),H="Games",de="",[w,ue]=r.useState([]),[h,me]=r.useState([]),[_,I]=r.useState(!0),[Le,xe]=r.useState(""),[b,K]=r.useState([]),[ke,W]=r.useState(!0),[S,qe]=r.useState([]),[J,De]=r.useState("");r.useMemo(()=>new Map(b.map(e=>[e.id,e])),[b]),r.useMemo(()=>new Set(b.map(e=>e.id)),[b]),r.useMemo(()=>{const e=J.trim().toLowerCase();return e?b.filter(s=>(s.display_name||"").toLowerCase().includes(e)||(s.id||"").toLowerCase().includes(e)):b},[b,J]);async function fe(e){W(!0);try{const[s,a]=await Promise.all([o.from("friends").select("friend_id").eq("user_id",e).eq("status","accepted"),o.from("friends").select("user_id").eq("friend_id",e).eq("status","accepted")]),n=[];!s.error&&Array.isArray(s.data)&&n.push(...s.data.map(l=>l.friend_id).filter(Boolean)),!a.error&&Array.isArray(a.data)&&n.push(...a.data.map(l=>l.user_id).filter(Boolean));const m=Array.from(new Set(n));if(m.length===0){const V=await o.from("profiles").select("id, user_id, display_name, name, avatar_url").neq("id",e).neq("user_id",e).limit(12),je=(!V.error&&Array.isArray(V.data)?V.data:[]).map(M=>({id:M.id||M.user_id,display_name:(M.display_name||M.name)??null,avatar_url:M.avatar_url??null}));K(je);return}const u="id, user_id, display_name, name, avatar_url";let i=[];const f=await o.from("profiles").select(u).in("id",m);if(!f.error&&f.data?.length)i=f.data;else{const l=await o.from("profiles").select(u).in("user_id",m);!l.error&&l.data?.length&&(i=l.data)}const ve=(i||[]).map(l=>({id:l.id||l.user_id,display_name:(l.display_name||l.name)??null,avatar_url:l.avatar_url??null})).filter(l=>m.includes(l.id));K(ve)}finally{W(!1)}}r.useEffect(()=>{let e=!0;return(async()=>{const{data:s,error:a}=await o.auth.getUser();if(!e)return;const n=a?void 0:s?.user?.id;n&&(xe(n),await fe(n))})(),()=>{e=!1}},[]),r.useEffect(()=>{let e=!0;return(async()=>{I(!0);const{data:s}=await o.from("allowed_categories").select("name").eq("is_active",!0),{data:a}=await o.from("allowed_games").select("id,name,category").eq("is_active",!0);e&&(ue(s??[]),me((a??[]).map(n=>({id:n.id,label:n.name,category:n.category}))),I(!1))})(),()=>{e=!1}},[]);const[L,pe]=r.useState(""),[O,he]=r.useState(""),[y,F]=r.useState(""),[P,X]=r.useState(!1),v=r.useMemo(()=>Se(y,p),[y,p]),j=!!v,[B,k]=r.useState(!1),[q,G]=r.useState(-1),D=r.useMemo(()=>{const e=y.trim().toLowerCase();return e?p.filter(s=>s.toLowerCase().includes(e)).slice(0,8):p.slice(0,8)},[y,p]),[x,Y]=r.useState(3),[Z,T]=r.useState(!1),[R,ee]=r.useState(""),[c,te]=r.useState("");r.useEffect(()=>{if(!w.length)return;const e=String(H),s=w.find(a=>a.name.toLowerCase()===e.toLowerCase());te((s?.name||w[0].name).toLowerCase())},[w,H]);const[se,Q]=r.useState(!1),[U,ae]=r.useState(""),[g,z]=r.useState("");r.useEffect(()=>{if(!h.length||!c)return;const e="".toLowerCase().replace(/\s+/g,""),s=h.find(a=>a.id===e||a.label.toLowerCase().replace(/\s+/g,"")===e);s&&z(s.id)},[h,de,c]);const re=r.useMemo(()=>{const e=R.trim().toLowerCase(),s=w.map(a=>a.name);return e?s.filter(a=>a.toLowerCase().includes(e)):s},[R,w]),ne=r.useMemo(()=>{const e=h.filter(a=>a.category.toLowerCase()===(c||"").toLowerCase()),s=U.trim().toLowerCase();return s?e.filter(a=>a.label.toLowerCase().includes(s)||a.id.includes(s)):e},[c,U,h]),ie=!_&&L.trim().length>0&&c&&g&&x>=3&&x<=16&&j,[d,le]=r.useState(1),oe=L.trim().length>0&&!!c&&!!g,ce=j&&x>=3&&x<=16;function ge(){d===1&&!oe||d===2&&!ce||le(e=>Math.min(3,e+1))}function be(){le(e=>Math.max(1,e-1))}async function we(e,s){if(S.length){try{const{error:a}=await o.rpc("send_group_invites",{p_group_id:e,p_recipient_ids:S});if(!a){console.debug("[CreateGroup] send_group_invites RPC ok",{groupId:e,inviteeCount:S.length});return}console.warn("[CreateGroup] send_group_invites RPC failed, will fallback",a?.message)}catch(a){console.warn("[CreateGroup] send_group_invites RPC threw, will fallback",a)}try{const a=S.map(m=>({group_id:e,inviter_id:s,recipient_id:m,status:"pending"})),{error:n}=await o.from("group_invitations").insert(a);n&&console.warn("[CreateGroup] group_invitations insert failed",n.message)}catch{}try{let a=null;try{const{data:i}=await o.from("groups").select("title").eq("id",e).maybeSingle();a=i?.title??null}catch{}let n=null;try{const{data:i}=await o.from("profiles").select("display_name,name").in("id",[s]).maybeSingle();n=i?.display_name||i?.name||null}catch{}const m=S.map(i=>({user_id:i,kind:"group_invite",payload:{group_id:e,group_title:a,inviter_id:s,inviter_name:n},is_read:!1})),{error:u}=await o.from("notifications").insert(m);u&&console.warn("[CreateGroup] notifications insert likely blocked by RLS (expected). Use RPC send_group_invites.",u.message)}catch{}}}async function ye(){if(!ie)return;if(!j){X(!0);return}const{data:e,error:s}=await o.auth.getUser();if(s||!e?.user?.id){alert(s?.message||"Sign in required");return}const a=e.user.id,n=Math.max(3,Math.min(16,x)),m=v??null,u={title:L.trim(),purpose:O.trim().replace(/\s+$/,"")||null,category:(c||"").toLowerCase(),game:g,city:m,capacity:n,visibility:"public",host_id:a},{data:i,error:f}=await o.from("groups").insert(u).select("id").single();if(f){alert(f.message);return}we(i.id,a),$(`/group/${i.id}`)}return t.jsx("div",{className:"min-h-screen bg-neutral-50",children:t.jsxs("div",{className:"mx-auto w-full max-w-xl px-4 pb-10 pt-6",children:[t.jsxs("div",{className:"mb-6 flex items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-semibold tracking-tight",children:"Start a new Circle"}),t.jsx("p",{className:"mt-1 text-sm text-neutral-600",children:"A small, calm group for the right people. 3 quick steps."})]}),t.jsx(_e,{to:"/browse",className:"shrink-0 rounded-full border border-neutral-200 px-3 py-1.5 text-xs font-medium text-neutral-700 hover:bg-neutral-100",children:"Back"})]}),t.jsx("div",{className:"mb-6 flex items-center justify-between text-xs font-medium text-neutral-600",children:[{id:1,label:"Basics"},{id:2,label:"Location"},{id:3,label:"Details"}].map(e=>{const s=d===e.id,a=d>e.id;return t.jsxs("div",{className:"flex flex-1 items-center gap-2",children:[t.jsx("div",{className:["flex h-7 w-7 items-center justify-center rounded-full border text-[11px]",s?"border-emerald-600 bg-emerald-600 text-white":a?"border-emerald-400 bg-emerald-50 text-emerald-700":"border-neutral-300 bg-white text-neutral-500"].join(" "),children:e.id}),t.jsx("span",{className:s?"text-neutral-900":"text-neutral-500",children:e.label})]},e.id)})}),t.jsxs("div",{className:"space-y-4",children:[d===1&&t.jsxs("section",{className:"rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm",children:[t.jsx("h2",{className:"mb-3 text-sm font-semibold text-neutral-800",children:"Basics"}),_&&t.jsx("div",{className:"mb-2 text-xs text-neutral-500",children:"Loading categoriesâ€¦"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Title"}),t.jsx("input",{value:L,onChange:e=>pe(e.target.value),placeholder:"e.g., Friday Night Hokm",className:"mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Category"}),t.jsxs("div",{className:"relative mt-1",children:[t.jsx("input",{value:Z?R:c||"",onChange:e=>{T(!0),ee(e.target.value)},onFocus:()=>T(!0),placeholder:"Search or choose categoryâ€¦",className:"w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30",disabled:_}),Z&&t.jsxs("div",{className:"absolute z-20 mt-1 max-h-56 w-full overflow-auto rounded-lg border bg-white shadow-lg",children:[re.length===0&&t.jsx("div",{className:"px-3 py-2 text-sm text-neutral-500",children:"No matches"}),re.map(e=>t.jsx("button",{type:"button",onClick:()=>{te(e.toLowerCase()),T(!1),ee(""),h.some(s=>s.category===e&&s.id===g)||z("")},className:"block w-full px-3 py-2 text-left text-sm hover:bg-neutral-50",children:e},e))]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Game / Activity"}),t.jsxs("div",{className:"relative mt-1",children:[t.jsx("input",{value:se?U:h.find(e=>e.category.toLowerCase()===(c||"").toLowerCase()&&e.id===g)?.label||"",onChange:e=>{Q(!0),ae(e.target.value)},onFocus:()=>Q(!0),placeholder:"Search or choose game/activityâ€¦",className:"w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30",disabled:_||!(c&&c.trim().length>0)}),se&&t.jsxs("div",{className:"absolute z-20 mt-1 max-h-56 w-full overflow-auto rounded-lg border bg-white shadow-lg",children:[ne.length===0&&t.jsx("div",{className:"px-3 py-2 text-sm text-neutral-500",children:"No matches"}),ne.map(e=>t.jsx("button",{type:"button",onClick:()=>{z(e.id),Q(!1),ae("")},className:"block w-full px-3 py-2 text-left text-sm hover:bg-neutral-50",children:e.label},e.id))]})]})]})]})]}),d===2&&t.jsxs("section",{className:"rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm",children:[t.jsx("h2",{className:"mb-3 text-sm font-semibold text-neutral-800",children:"Location & size"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"relative",children:[t.jsxs("label",{className:"block text-xs font-medium text-neutral-700",children:["City ",t.jsx("span",{className:"text-red-600",children:"*"})]}),t.jsx("input",{value:y,onChange:e=>{F(e.target.value),k(!0),G(-1)},onFocus:async()=>{await N(),k(!0)},onBlur:()=>{setTimeout(()=>k(!1),120),X(!0)},onKeyDown:e=>{B&&(e.key==="ArrowDown"?(e.preventDefault(),G(s=>Math.min(D.length-1,s+1))):e.key==="ArrowUp"?(e.preventDefault(),G(s=>Math.max(-1,s-1))):e.key==="Enter"&&q>=0&&D[q]&&(e.preventDefault(),F(D[q]),k(!1)))},placeholder:"Start typingâ€¦ e.g., Offenburg",className:["mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30",P&&!j?"border-red-400 focus:border-red-500":""].join(" "),"aria-autocomplete":"list","aria-expanded":B,"aria-controls":"city-suggest",role:"combobox"}),B&&D.length>0&&t.jsx("div",{id:"city-suggest",className:"absolute z-20 mt-1 max-h-64 w-full overflow-auto rounded-lg border border-neutral-200 bg-white shadow-lg",role:"listbox",children:D.map((e,s)=>t.jsx("button",{type:"button",onMouseDown:a=>a.preventDefault(),onClick:()=>{F(e),k(!1),G(-1)},className:["flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-emerald-50",s===q?"bg-emerald-50":""].join(" "),role:"option","aria-selected":s===q,children:t.jsx("span",{className:"truncate",children:e})},e+s))}),!j&&P&&t.jsx("p",{className:"mt-1 text-xs text-red-600",children:"Choose a city from suggestions."}),j&&P&&v!==y&&t.jsxs("p",{className:"mt-1 text-xs text-neutral-500",children:["Using â€œ",v,"â€."]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Capacity"}),t.jsx("div",{className:"mt-1 flex items-center gap-3",children:t.jsx("input",{type:"number",value:x===0?"":x,onChange:e=>{const s=e.target.value;if(s===""){Y(0);return}const a=Number(s);Y(a)},placeholder:"3â€“16",className:"w-24 rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30"})}),(x<3||x>16)&&x!==0&&t.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Capacity must be between 3 and 16."})]})]})]}),d===3&&t.jsxs("section",{className:"rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm",children:[t.jsx("h2",{className:"mb-3 text-sm font-semibold text-neutral-800",children:"Details & preview"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-neutral-700",children:"Description"}),t.jsx("textarea",{value:O,onChange:e=>he(e.target.value),placeholder:"Tell people what this circle is aboutâ€¦",rows:4,className:"mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm outline-none shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/30"})]}),t.jsxs("div",{className:"rounded-xl border border-dashed border-neutral-200 bg-neutral-50 p-3 text-xs text-neutral-700",children:[t.jsx("div",{className:"mb-1 text-[11px] font-semibold uppercase tracking-wide text-neutral-500",children:"Preview"}),t.jsx("div",{className:"text-sm font-semibold text-neutral-900",children:L||"Untitled Circle"}),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-neutral-600",children:[c&&t.jsx("span",{className:"rounded-full bg-white px-2 py-0.5",children:c}),g&&t.jsx("span",{className:"rounded-full bg-white px-2 py-0.5",children:h.find(e=>e.id===g)?.label||g}),v&&t.jsxs("span",{className:"rounded-full bg-white px-2 py-0.5 flex items-center gap-1",children:[t.jsx("span",{children:"ðŸ“"}),v]}),t.jsxs("span",{className:"rounded-full bg-white px-2 py-0.5",children:[x," spots"]})]}),O&&t.jsx("p",{className:"mt-2 line-clamp-3 text-xs text-neutral-700",children:O})]})]})]})]}),t.jsxs("div",{className:"mt-6 flex items-center justify-between gap-3",children:[t.jsx("button",{type:"button",onClick:d===1?()=>$("/browse"):be,className:"rounded-full border border-neutral-200 px-3 py-1.5 text-xs font-medium text-neutral-700 hover:bg-neutral-100",children:d===1?"Cancel":"Back"}),t.jsxs("div",{className:"flex gap-2",children:[d<3&&t.jsx("button",{type:"button",onClick:ge,disabled:d===1&&!oe||d===2&&!ce||_,className:"rounded-full bg-emerald-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 disabled:opacity-60",children:"Next"}),d===3&&t.jsx("button",{type:"button",disabled:!ie,onClick:ye,className:"rounded-full bg-emerald-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 disabled:opacity-60",children:"Create Circle"})]})]})]})})}export{Oe as default};
