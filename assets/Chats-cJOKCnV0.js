const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatPanel-DGozPfbf.js","assets/index-BFSOJQ8p.js","assets/react-Dymf0t1b.js","assets/supabase-BesQZUkt.js","assets/index-FIZlDCRR.css","assets/useGroupPresence-C2upsTTn.js","assets/ViewOtherProfileModal-C8uVw2Bj.js","assets/user-plus-D6OwJxO9.js","assets/map-pin-B0hwBbkr.js","assets/send-D-31sDb8.js"])))=>i.map(i=>d[i]);
import{c as z,j as e,s as m,U as J,M as D,_ as B}from"./index-BFSOJQ8p.js";import{i as K,u as W,c as n}from"./react-Dymf0t1b.js";import{V as Q}from"./ViewOtherProfileModal-C8uVw2Bj.js";import{S as X}from"./search-DcCgcw5G.js";import{A as Y}from"./arrow-left-PSsh7f_2.js";import{S as Z}from"./send-D-31sDb8.js";import"./supabase-BesQZUkt.js";import"./user-plus-D6OwJxO9.js";const ee=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],te=z("funnel",ee);const se=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]],P=z("heart",se);function R({size:p=20,className:v=""}){return e.jsxs("svg",{className:`animate-spin ${v}`,width:p,height:p,viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]})}const re=n.lazy(()=>B(()=>import("./ChatPanel-DGozPfbf.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])));function fe(){const p=K(),v=W(),[c,O]=n.useState(null),[g,j]=n.useState([]),[F,T]=n.useState(!0),[s,f]=n.useState(null),[$,C]=n.useState(null),[y,N]=n.useState([]),[h,k]=n.useState(""),[I,q]=n.useState(!1),_=n.useRef(null),S=n.useRef(null),[b,U]=n.useState("all"),[E,V]=n.useState("");n.useEffect(()=>{async function t(){const{data:{user:r}}=await m.auth.getUser();if(!r)return;O(r.id);const l=new Set(JSON.parse(localStorage.getItem("chat_favorites")||"[]")),{data:a}=await m.from("group_members").select("group_id, groups(id, title, category)").eq("user_id",r.id).in("status",["active","accepted"]),{data:o}=await m.from("friendships").select("user_id_a, user_id_b").or(`user_id_a.eq.${r.id},user_id_b.eq.${r.id}`).eq("status","accepted"),d=[];if(a&&a.forEach(i=>{i.groups&&d.push({type:"group",id:i.groups.id,name:i.groups.title,avatar_url:null,subtitle:i.groups.category||"Group",isFavorite:l.has(i.groups.id)})}),o){const i=o.map(u=>u.user_id_a===r.id?u.user_id_b:u.user_id_a);if(i.length>0){const{data:u}=await m.from("profiles").select("user_id, name, avatar_url").in("user_id",i);u?.forEach(x=>{d.push({type:"dm",id:x.user_id,name:x.name||"User",avatar_url:x.avatar_url,subtitle:"Direct Message",isFavorite:l.has(x.user_id)})})}}d.sort((i,u)=>i.isFavorite&&!u.isFavorite?-1:!i.isFavorite&&u.isFavorite?1:i.name.localeCompare(u.name)),j(d),T(!1)}t()},[]);const L=t=>{const r=new Set(JSON.parse(localStorage.getItem("chat_favorites")||"[]"));let l=!1;r.has(t)?(r.delete(t),l=!1):(r.add(t),l=!0),localStorage.setItem("chat_favorites",JSON.stringify(Array.from(r))),j(a=>a.map(o=>o.id===t?{...o,isFavorite:l}:o).sort((o,d)=>o.isFavorite&&!d.isFavorite?-1:!o.isFavorite&&d.isFavorite?1:o.name.localeCompare(d.name))),s&&s.id===t&&f(a=>a?{...a,isFavorite:l}:null)};n.useEffect(()=>{const t=v.state?.openDmId;if(t&&g.length>0&&!s){const r=g.find(l=>l.id===t&&l.type==="dm");r?f(r):(async()=>{const{data:l}=await m.from("profiles").select("name, avatar_url").eq("user_id",t).single();if(l){const a=new Set(JSON.parse(localStorage.getItem("chat_favorites")||"[]")),o={type:"dm",id:t,name:l.name||"User",avatar_url:l.avatar_url,subtitle:"Direct Message",isFavorite:a.has(t)};j(d=>[o,...d]),f(o)}})(),window.history.replaceState({},"")}},[v.state,g,s]),n.useEffect(()=>{if(!c||!s||s.type!=="dm")return;let t=null,r=null;async function l(){q(!0);const a=s.id,{data:o}=await m.from("direct_messages").select("id, sender, receiver, content, created_at").or(`and(sender.eq.${c},receiver.eq.${a}),and(sender.eq.${a},receiver.eq.${c})`).order("created_at",{ascending:!0}).limit(100);N(o||[]),q(!1),setTimeout(()=>_.current?.scrollIntoView({behavior:"smooth"}),100),t=m.channel(`dm:${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"direct_messages",filter:`or(and(sender.eq.${c},receiver.eq.${a}),and(sender.eq.${a},receiver.eq.${c}))`},d=>{const i=d.new;(i.sender===c&&i.receiver===a||i.sender===a&&i.receiver===c)&&(N(x=>[...x,i]),setTimeout(()=>_.current?.scrollIntoView({behavior:"smooth"}),100))}).subscribe(),r=setInterval(async()=>{const{data:d}=await m.from("direct_messages").select("id, sender, receiver, content, created_at").or(`and(sender.eq.${c},receiver.eq.${a}),and(sender.eq.${a},receiver.eq.${c})`).order("created_at",{ascending:!0}).limit(100);d&&N(d)},5e3)}return l(),()=>{t&&m.removeChannel(t),r&&clearInterval(r)}},[s,c]),n.useEffect(()=>{s?.type==="dm"&&S.current?.focus()},[s]);const M=async()=>{if(!h.trim()||!c||!s||s.type!=="dm")return;const t=h.trim();k(""),S.current?.focus(),await m.from("direct_messages").insert({sender:c,receiver:s.id,content:t})},A=g.filter(t=>!(b==="groups"&&t.type!=="group"||b==="private"&&t.type!=="dm"||b==="fav"&&!t.isFavorite||!t.name.toLowerCase().includes(E.toLowerCase()))),w=({id:t,label:r})=>e.jsx("button",{onClick:()=>U(t),className:`
        whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-semibold transition-all border
        ${b===t?"bg-neutral-900 text-white border-neutral-900 shadow-md transform scale-105":"bg-white text-neutral-600 border-neutral-200 hover:bg-neutral-50 hover:border-neutral-300"}
      `,children:r}),G=()=>e.jsxs("div",{className:`flex flex-col h-full bg-white border-r border-neutral-200 ${s?"hidden md:flex":"flex"} w-full md:w-80 lg:w-96`,children:[e.jsxs("div",{className:"p-5 border-b border-neutral-100 bg-white/80 backdrop-blur-md sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-neutral-900 tracking-tight",children:"Chats"}),F&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-neutral-900"})]}),e.jsxs("div",{className:"relative mb-4 group",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-neutral-400 group-focus-within:text-emerald-600 transition-colors",children:e.jsx(X,{className:"h-4 w-4"})}),e.jsx("input",{value:E,onChange:t=>V(t.target.value),placeholder:"Search conversations...",className:"block w-full pl-10 pr-3 py-2.5 border border-neutral-200 rounded-xl leading-5 bg-neutral-50 placeholder-neutral-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm font-medium"})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1 scrollbar-hide",children:[e.jsx(w,{id:"all",label:"All"}),e.jsx(w,{id:"groups",label:"Groups"}),e.jsx(w,{id:"private",label:"Private"}),e.jsx(w,{id:"fav",label:"Favorites"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:F?e.jsx("div",{className:"p-8 flex justify-center",children:e.jsx(R,{})}):A.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-neutral-400 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-neutral-50 rounded-full flex items-center justify-center mb-4",children:e.jsx(te,{className:"h-6 w-6 opacity-30"})}),e.jsx("p",{className:"text-sm font-medium",children:"No chats found."}),e.jsx("p",{className:"text-xs mt-1 opacity-70",children:"Try adjusting your filters or search."})]}):e.jsx("div",{className:"px-2 py-2 space-y-1",children:A.map(t=>e.jsxs("div",{className:"group relative",children:[e.jsxs("button",{onClick:()=>f(t),className:`
                    w-full flex items-center gap-3 p-3 rounded-xl text-left transition-all duration-200
                    ${s?.id===t.id?"bg-emerald-50 shadow-sm ring-1 ring-emerald-100":"hover:bg-neutral-50"}
                  `,children:[e.jsx("div",{className:`
                    h-12 w-12 rounded-full flex items-center justify-center text-lg font-bold shrink-0 shadow-sm
                    ${t.type==="group"?"bg-gradient-to-br from-indigo-100 to-indigo-200 text-indigo-700":"bg-gradient-to-br from-neutral-100 to-neutral-200 text-neutral-600"}
                  `,children:t.type==="dm"&&t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:"",className:"h-full w-full object-cover rounded-full"}):t.type==="group"?e.jsx(J,{className:"h-5 w-5"}):t.name.slice(0,1).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1 pr-8",children:[e.jsx("div",{className:`font-semibold truncate ${s?.id===t.id?"text-emerald-900":"text-neutral-900"}`,children:t.name}),e.jsx("div",{className:"text-xs text-neutral-500 truncate mt-0.5",children:t.subtitle})]})]}),e.jsx("button",{onClick:r=>{r.stopPropagation(),L(t.id)},className:`
                    absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full transition-all duration-200
                    hover:bg-white hover:shadow-sm
                    ${t.isFavorite?"opacity-100 text-rose-500":"opacity-0 group-hover:opacity-100 text-neutral-300 hover:text-rose-400"}
                  `,title:t.isFavorite?"Remove from Favorites":"Add to Favorites",children:e.jsx(P,{className:`h-4 w-4 ${t.isFavorite?"fill-current":""}`})})]},t.type+t.id))})})]}),H=()=>{if(!s)return e.jsxs("div",{className:"hidden md:flex flex-1 items-center justify-center bg-neutral-50/50 flex-col gap-6",children:[e.jsx("div",{className:"bg-white p-6 rounded-full shadow-sm ring-1 ring-black/5",children:e.jsx(D,{className:"h-12 w-12 text-emerald-500/50"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900",children:"Select a conversation"}),e.jsx("p",{className:"text-sm text-neutral-500 mt-1",children:"Choose a group or friend to start chatting"})]})]});const t=()=>{s.type==="group"?p(`/group/${s.id}`):s.type==="dm"&&C(s.id)};return e.jsxs("div",{className:"fixed inset-0 z-50 pb-20 md:pb-0 md:static md:inset-auto md:flex-1 bg-white flex flex-col h-full",children:[e.jsxs("div",{className:"h-[72px] border-b border-neutral-200 flex items-center px-4 gap-4 bg-white/95 backdrop-blur-sm shrink-0 shadow-sm z-20",children:[e.jsx("button",{onClick:()=>f(null),className:"md:hidden p-2 -ml-2 rounded-full hover:bg-neutral-100 transition-colors",children:e.jsx(Y,{className:"h-5 w-5 text-neutral-600"})}),e.jsxs("div",{onClick:t,className:"flex items-center gap-4 flex-1 min-w-0 cursor-pointer hover:opacity-70 transition-opacity",title:`View ${s.type==="group"?"Group":"Profile"}`,children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center text-sm font-bold shadow-sm ${s.type==="group"?"bg-indigo-100 text-indigo-700":"bg-neutral-100 text-neutral-600"}`,children:s.type==="dm"&&s.avatar_url?e.jsx("img",{src:s.avatar_url,alt:"",className:"h-full w-full object-cover rounded-full"}):s.type==="group"?"#":s.name.slice(0,1)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-bold text-neutral-900 truncate text-base",children:s.name}),e.jsxs("div",{className:"text-xs text-neutral-500 flex items-center gap-1",children:[e.jsx("span",{className:`w-1.5 h-1.5 rounded-full ${s.type==="group"?"bg-indigo-500":"bg-emerald-500"}`}),s.type==="group"?"Group Chat":"Direct Message"]})]})]}),e.jsx("button",{onClick:()=>L(s.id),className:"p-2 rounded-full hover:bg-neutral-100 transition-colors focus:outline-none focus:ring-2 focus:ring-neutral-200",title:s.isFavorite?"Remove from Favorites":"Add to Favorites",children:e.jsx(P,{className:`h-5 w-5 transition-colors ${s.isFavorite?"fill-rose-500 text-rose-500":"text-neutral-400"}`})})]}),e.jsxs("div",{className:"flex-1 overflow-hidden relative bg-neutral-50",children:[e.jsx("div",{className:"absolute inset-0 opacity-[0.03] pointer-events-none",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='1'/%3E%3C/g%3E%3C/svg%3E")`}}),s.type==="group"?e.jsx(n.Suspense,{fallback:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx(R,{})}),children:e.jsx("div",{className:"h-full w-full relative z-10",children:e.jsx(re,{groupId:s.id,onClose:()=>f(null),full:!0,setFull:()=>{},user:{id:c}})})}):e.jsxs("div",{className:"flex flex-col h-full relative z-10",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[I&&e.jsx("div",{className:"flex justify-center py-4",children:e.jsx("div",{className:"bg-white/80 px-4 py-1.5 rounded-full text-xs font-medium text-neutral-500 shadow-sm border border-neutral-100",children:"Loading history..."})}),!I&&y.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-neutral-400 space-y-3",children:[e.jsx("div",{className:"w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center",children:e.jsx(D,{className:"h-8 w-8 text-neutral-200"})}),e.jsx("div",{className:"text-sm",children:"No messages yet. Say hi! ðŸ‘‹"})]}),y.map((r,l)=>{const a=r.sender===c,o=!a&&(l===0||y[l-1].sender!==r.sender);return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"} group animate-in fade-in slide-in-from-bottom-2 duration-300`,children:e.jsxs("div",{className:`flex max-w-[80%] md:max-w-[70%] ${a?"flex-row-reverse":"flex-row"} items-end gap-2`,children:[!a&&e.jsx("div",{className:"w-6 h-6 shrink-0 mb-1",children:o&&(s.avatar_url?e.jsx("img",{src:s.avatar_url,className:"w-6 h-6 rounded-full object-cover shadow-sm"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 flex items-center justify-center text-[9px] font-bold text-neutral-500",children:s.name.slice(0,1)}))}),e.jsxs("div",{className:`
                          px-4 py-2.5 text-sm shadow-sm relative
                          ${a?"bg-gradient-to-br from-emerald-500 to-emerald-600 text-white rounded-2xl rounded-tr-sm":"bg-white text-neutral-800 border border-neutral-100 rounded-2xl rounded-tl-sm"}
                        `,children:[r.content,e.jsx("div",{className:`text-[9px] mt-1 text-right opacity-70 ${a?"text-emerald-100":"text-neutral-400"}`,children:new Date(r.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},r.id)}),e.jsx("div",{ref:_})]}),e.jsx("div",{className:"p-4 bg-white border-t border-neutral-200/80 backdrop-blur-md",children:e.jsxs("div",{className:"flex items-center gap-2 max-w-4xl mx-auto bg-neutral-50 border border-neutral-200 rounded-full px-2 py-2 focus-within:ring-2 focus-within:ring-emerald-500/20 focus-within:border-emerald-500 transition-all shadow-inner",children:[e.jsx("input",{ref:S,value:h,onChange:r=>k(r.target.value),onKeyDown:r=>r.key==="Enter"&&M(),autoFocus:!0,placeholder:"Type a message...",className:"flex-1 bg-transparent border-0 px-4 py-1 text-sm focus:ring-0 text-neutral-900 placeholder-neutral-400 outline-none"}),e.jsx("button",{onClick:M,disabled:!h.trim(),className:`
                      p-2.5 rounded-full transition-all duration-200 flex items-center justify-center shadow-sm
                      ${h.trim()?"bg-emerald-600 text-white hover:bg-emerald-700 hover:scale-105 active:scale-95":"bg-neutral-200 text-neutral-400 cursor-not-allowed"}
                    `,children:e.jsx(Z,{className:"h-4 w-4 ml-0.5"})})]})})]})]})]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex h-[calc(100vh-64px)] w-full overflow-hidden bg-white fixed top-0 left-0",children:[e.jsx(G,{}),e.jsx(H,{})]}),e.jsx(Q,{isOpen:!!$,onClose:()=>C(null),viewUserId:$})]})}export{fe as default};
